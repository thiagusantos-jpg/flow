<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProjectFlow - Gest√£o de Projetos</title>

  <!-- Favicon SVG -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%230f172a'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='18'>üöÄ</text></svg>">

  <!-- PWA Meta Tags -->
  <meta name="description" content="ProjectFlow - Gest√£o inteligente de projetos com Kanban, Gantt, Calendar e Timesheet">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ProjectFlow">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#0f172a">

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7_oqRERkaoQ4V2B0tSUXK7lvSXn67pmo",
      authDomain: "projectflow-e22cc.firebaseapp.com",
      databaseURL: "https://projectflow-e22cc-default-rtdb.firebaseio.com",
      projectId: "projectflow-e22cc",
      storageBucket: "projectflow-e22cc.firebasestorage.app",
      messagingSenderId: "114510446369",
      appId: "1:114510446369:web:ec791cffcea4d4cec00860"
    };
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --pf-primary: #06b6d4;
      --pf-accent: #3b82f6;
      --pf-bg: #0f172a;
      --pf-surface: rgba(255,255,255,0.05);
    }
    * {
      font-family: 'Outfit', sans-serif;
    }

    .font-mono {
      font-family: 'Space Mono', monospace;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    @keyframes viewTransition {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-view-transition {
      animation: viewTransition 0.3s ease-out;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 8px 2px rgba(239, 68, 68, 0.2); }
    }

    .animate-slide-in {
      animation: slideIn 0.6s ease-out;
    }

    .animate-fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .animate-scale-in {
      animation: scaleIn 0.3s ease-out;
    }

    .gantt-bar {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gantt-bar:hover {
      transform: translateY(-2px);
      filter: brightness(1.2);
    }

    .project-card {
      transition: all 0.3s ease;
    }

    .project-card:hover {
      transform: translateX(4px);
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-row {
      transition: background 0.2s ease;
    }

    .task-row:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .overdue-pulse {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 8px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.15);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Mobile sidebar toggle */
    @media (max-width: 1023px) {
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 40;
      }
      .sidebar-panel {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 300px;
        z-index: 50;
        overflow-y: auto;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar-panel.open {
        transform: translateX(0);
      }
    }
    /* Print styles */
    @media print {
      body { background: white !important; color: black !important; }
      .no-print { display: none !important; }
      .glass { background: white !important; border: 1px solid #ddd !important; }
      .print-only { display: block !important; }
      * { color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
    .print-only { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // √çcones Lucide (inline SVG components)
    const Plus = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Calendar = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const ChevronRight = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const Trash2 = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const Edit2 = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      </svg>
    );

    const GripVertical = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="9" cy="12" r="1"></circle>
        <circle cx="9" cy="5" r="1"></circle>
        <circle cx="9" cy="19" r="1"></circle>
        <circle cx="15" cy="12" r="1"></circle>
        <circle cx="15" cy="5" r="1"></circle>
        <circle cx="15" cy="19" r="1"></circle>
      </svg>
    );

    const Search = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    );

    const Download = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const Menu = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    );

    const AlertTriangle = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    );

    const X = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Users = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
    );

    const Clock = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );

    const Play = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
    );

    const Square = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      </svg>
    );

    const Cloud = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
      </svg>
    );

    const CloudOff = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path>
        <line x1="1" y1="1" x2="23" y2="23"></line>
      </svg>
    );

    const Copy = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );

    const SettingsIcon = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    );

    const Palette = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="13.5" cy="6.5" r="1.5"></circle><circle cx="17.5" cy="10.5" r="1.5"></circle><circle cx="8.5" cy="7.5" r="1.5"></circle><circle cx="6.5" cy="12" r="1.5"></circle>
        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.5-.67 1.5-1.5 0-.38-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c3.31 0 6-2.69 6-6 0-5.5-4.5-9-10-9z"></path>
      </svg>
    );

    const LinkIcon = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    );

    // Cloud status indicator component
    function CloudStatusBadge({ status }) {
      const config = {
        connecting: { icon: Cloud, color: 'text-yellow-400', label: 'Conectando...' },
        synced: { icon: Cloud, color: 'text-emerald-400', label: 'Sincronizado' },
        offline: { icon: CloudOff, color: 'text-red-400', label: 'Offline (local)' },
      };
      const { icon: Icon, color, label } = config[status] || config.connecting;
      return (
        <div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 text-xs font-mono ${color}`} title={label}>
          <Icon className="w-3.5 h-3.5" />
          <span className="hidden sm:inline">{label}</span>
        </div>
      );
    }

    // Utility functions
    const getDatePosition = (date, startDate, totalDays) => {
      const diff = Math.floor((new Date(date) - new Date(startDate)) / (1000 * 60 * 60 * 24));
      return (diff / totalDays) * 100;
    };

    const getDuration = (start, end) => {
      return Math.floor((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
    };

    const getDateRange = (project) => {
      if (!project || project.tasks.length === 0) return null;

      const dates = project.tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      minDate.setDate(minDate.getDate() - 2);
      maxDate.setDate(maxDate.getDate() + 7);

      const totalDays = Math.floor((maxDate - minDate) / (1000 * 60 * 60 * 24));

      return { minDate, maxDate, totalDays };
    };

    const isOverdue = (task) => {
      if (task.status === 'completed') return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return new Date(task.end) < today;
    };

    const isDueSoon = (task) => {
      if (task.status === 'completed') return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const end = new Date(task.end);
      const diffDays = Math.floor((end - today) / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= 2;
    };

    const priorityConfig = {
      high: { label: 'Alta', icon: 'üî¥', class: 'bg-red-500/15 text-red-400' },
      medium: { label: 'M√©dia', icon: 'üü°', class: 'bg-amber-500/15 text-amber-400' },
      low: { label: 'Baixa', icon: 'üü¢', class: 'bg-emerald-500/15 text-emerald-400' },
    };

    function PriorityBadge({ priority }) {
      const p = priorityConfig[priority];
      if (!p) return null;
      return <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium ${p.class}`}>{p.icon} {p.label}</span>;
    }

    // Loading Skeleton Component
    function LoadingSkeleton() {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
          <div className="glass border-b border-white/10 px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between max-w-7xl mx-auto">
            <div className="flex items-center gap-4">
              <div className="skeleton w-32 h-8" />
              <div className="skeleton w-24 h-4" />
            </div>
            <div className="flex gap-2">
              <div className="skeleton w-20 h-8 rounded-lg" />
              <div className="skeleton w-20 h-8 rounded-lg" />
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
            <div className="flex gap-6">
              <div className="hidden lg:block w-72 flex-shrink-0 space-y-3">
                <div className="skeleton h-10 w-full rounded-xl" />
                <div className="skeleton h-20 w-full rounded-xl" />
                <div className="skeleton h-20 w-full rounded-xl" />
                <div className="skeleton h-20 w-full rounded-xl" />
              </div>
              <div className="flex-1 space-y-4">
                <div className="skeleton h-32 w-full rounded-2xl" />
                <div className="skeleton h-12 w-full rounded-xl" />
                <div className="skeleton h-64 w-full rounded-2xl" />
              </div>
            </div>
          </div>
          <div className="fixed inset-0 flex items-center justify-center pointer-events-none">
            <div className="text-center animate-fade-in">
              <Cloud className="w-8 h-8 text-cyan-400 mx-auto mb-2 animate-pulse" />
              <p className="text-sm text-slate-400">Conectando ao servidor...</p>
            </div>
          </div>
        </div>
      );
    }

    // Custom confirm modal (replaces browser confirm)
    function ConfirmModal({ message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[200] animate-fade-in" onClick={onCancel}>
          <div className="bg-slate-800 border border-slate-600 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl animate-scale-in" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 bg-red-500/20 rounded-xl"><AlertTriangle className="w-5 h-5 text-red-400" /></div>
              <h3 className="text-lg font-semibold text-white">Confirmar a√ß√£o</h3>
            </div>
            <p className="text-slate-300 mb-6">{message}</p>
            <div className="flex gap-3 justify-end">
              <button onClick={onCancel} className="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium transition">Cancelar</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition">Confirmar</button>
            </div>
          </div>
        </div>
      );
    }

    // Toast notification component
    function Toast({ message, type, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      const config = {
        success: { bg: 'bg-emerald-500/90 border-emerald-400', icon: '‚úÖ' },
        error: { bg: 'bg-red-500/90 border-red-400', icon: '‚ùå' },
        info: { bg: 'bg-cyan-500/90 border-cyan-400', icon: '‚ÑπÔ∏è' },
      };
      const c = config[type] || config.info;

      return (
        <div className={`fixed bottom-6 right-6 z-[100] px-5 py-3 rounded-xl border text-white text-sm font-medium shadow-2xl animate-scale-in flex items-center gap-2 ${c.bg}`} role="alert">
          <span>{c.icon}</span>
          {message}
          <button onClick={onClose} className="ml-2 hover:opacity-70 transition" aria-label="Fechar notifica√ß√£o">‚úï</button>
        </div>
      );
    }

    // Demo project (used when database is empty)
    const createDemoProject = () => ({
      id: Date.now(),
      name: 'Evento Abbott LAC 2026',
      color: '#FF6B35',
      tasks: [
        {
          id: 1,
          name: 'Concept & Briefing',
          description: 'Reuni√£o inicial com cliente para entender objetivos do evento, p√∫blico-alvo e definir o conceito criativo FLOWGETHER',
          start: '2026-02-05',
          end: '2026-02-12',
          status: 'completed',
          progress: 100,
          assignee: 'Thiago'
        },
        {
          id: 2,
          name: 'Design Key Visual',
          description: 'Cria√ß√£o da identidade visual principal do evento, incluindo logo, paleta de cores e elementos gr√°ficos do tema',
          start: '2026-02-13',
          end: '2026-02-25',
          status: 'in-progress',
          progress: 65,
          assignee: 'Thiago',
          dependencies: [1]
        },
        {
          id: 3,
          name: 'Aprova√ß√£o Cliente',
          description: 'Apresenta√ß√£o do conceito final e key visual para aprova√ß√£o do cliente e ajustes necess√°rios',
          start: '2026-02-26',
          end: '2026-03-02',
          status: 'pending',
          progress: 0,
          assignee: 'Cliente',
          dependencies: [2]
        },
        {
          id: 4,
          name: 'Produ√ß√£o Stand 3D',
          description: 'Modelagem 3D do stand corporativo, renders finais e especifica√ß√µes t√©cnicas para produ√ß√£o',
          start: '2026-03-03',
          end: '2026-03-20',
          status: 'pending',
          progress: 0,
          assignee: 'Equipe 3D',
          dependencies: [3]
        }
      ]
    });

    // Firebase helpers
    const saveToFirebase = (projectsData) => {
      try {
        db.ref('projects').set(projectsData);
      } catch (e) {
        console.error('Erro ao salvar no Firebase:', e);
      }
    };

    const saveTeamToFirebase = (teamData) => {
      try {
        db.ref('team').set(teamData);
      } catch (e) {
        console.error('Erro ao salvar equipe no Firebase:', e);
      }
    };

    const saveTimeLogsToFirebase = (logs) => {
      try {
        db.ref('timeLogs').set(logs);
      } catch (e) {
        console.error('Erro ao salvar time logs no Firebase:', e);
      }
    };

    // Format seconds to HH:MM:SS
    const formatTime = (seconds) => {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    };

    // Format seconds to readable hours
    const formatHours = (seconds) => {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (h === 0) return `${m}min`;
      return m > 0 ? `${h}h ${m}min` : `${h}h`;
    };

    const saveEmailConfigToFirebase = (config) => {
      try {
        db.ref('emailConfig').set(config);
      } catch (e) {
        console.error('Erro ao salvar config email no Firebase:', e);
      }
    };

    // Send email notification via EmailJS
    const sendTaskEmail = (emailConfig, member, task, projectName) => {
      if (!emailConfig || !emailConfig.serviceId || !emailConfig.templateId || !emailConfig.publicKey) return false;
      try {
        emailjs.send(emailConfig.serviceId, emailConfig.templateId, {
          to_name: member.name,
          to_email: member.email,
          task_name: task.name,
          task_description: task.description || 'Sem descri√ß√£o',
          task_start: new Date(task.start).toLocaleDateString('pt-BR'),
          task_end: new Date(task.end).toLocaleDateString('pt-BR'),
          project_name: projectName,
          from_name: 'ProjectFlow',
        }, emailConfig.publicKey);
        return true;
      } catch (e) {
        console.error('Erro ao enviar email:', e);
        return false;
      }
    };

    // Main App Component
    function ProjectManager() {
      const [projects, setProjects] = useState([]);
      const [selectedProject, setSelectedProject] = useState(null);
      const [view, setView] = useState('gantt');
      const [showNewProject, setShowNewProject] = useState(false);
      const [showNewTask, setShowNewTask] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      const [priorityFilter, setPriorityFilter] = useState('all');
      const [sortBy, setSortBy] = useState('default');
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [toast, setToast] = useState(null);
      const [confirmModal, setConfirmModal] = useState(null);
      const [cloudStatus, setCloudStatus] = useState('connecting');
      const [team, setTeam] = useState([]);
      const [showTeamManager, setShowTeamManager] = useState(false);
      const [editingProject, setEditingProject] = useState(null);
      const [projectFilter, setProjectFilter] = useState('');
      const [emailConfig, setEmailConfig] = useState({ serviceId: '', templateId: '', publicKey: '' });
      const [timeLogs, setTimeLogs] = useState([]);
      const [activeTimer, setActiveTimer] = useState(null); // { taskId, projectId, startTime }
      const [timerTick, setTimerTick] = useState(0);
      const [showTimesheet, setShowTimesheet] = useState(false);
      const [showGlobalSearch, setShowGlobalSearch] = useState(false);
      const [activityLog, setActivityLog] = useState([]);
      const [showActivityLog, setShowActivityLog] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [appSettings, setAppSettings] = useState(() => {
        try {
          const saved = localStorage.getItem('pf_settings');
          return saved ? JSON.parse(saved) : {
            companyName: 'ProjectFlow',
            companyTagline: 'Gest√£o Visual de Projetos',
            logoUrl: '',
            primaryColor: '#06b6d4',
            accentColor: '#3b82f6',
            bgColor: '#0f172a',
          };
        } catch { return { companyName: 'ProjectFlow', companyTagline: 'Gest√£o Visual de Projetos', logoUrl: '', primaryColor: '#06b6d4', accentColor: '#3b82f6', bgColor: '#0f172a' }; }
      });
      const fileInputRef = useRef(null);
      const showConfirm = (message, onConfirm) => setConfirmModal({ message, onConfirm });
      const addActivity = (action, detail) => {
        setActivityLog(prev => [{ id: Date.now(), action, detail, time: new Date().toISOString() }, ...prev].slice(0, 50));
      };
      const isFirstLoad = useRef(true);
      const skipNextSave = useRef(false);
      const skipNextTeamSave = useRef(false);
      const skipNextTimeSave = useRef(false);

      // Persist settings & apply CSS variables
      useEffect(() => {
        localStorage.setItem('pf_settings', JSON.stringify(appSettings));
        const root = document.documentElement;
        root.style.setProperty('--pf-primary', appSettings.primaryColor || '#06b6d4');
        root.style.setProperty('--pf-accent', appSettings.accentColor || '#3b82f6');
        root.style.setProperty('--pf-bg', appSettings.bgColor || '#0f172a');
      }, [appSettings]);

      const showToast = useCallback((message, type = 'info') => {
        setToast({ message, type });
      }, []);

      // Keyboard shortcuts
      useEffect(() => {
        const handler = (e) => {
          if (e.key === 'Escape') {
            if (editingTask) { setEditingTask(null); return; }
            if (showNewTask) { setShowNewTask(false); return; }
            if (showNewProject) { setShowNewProject(false); return; }
            if (sidebarOpen) { setSidebarOpen(false); return; }
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'n' && selectedProject && !showNewTask && !editingTask) {
            e.preventDefault();
            setShowNewTask(true);
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, [editingTask, showNewTask, showNewProject, selectedProject, sidebarOpen]);

      // Firebase: real-time sync (load + listen for changes from other users)
      useEffect(() => {
        const projectsRef = db.ref('projects');

        const handleData = (snapshot) => {
          const data = snapshot.val();
          if (data && Array.isArray(data) && data.length > 0) {
            // Ensure tasks arrays exist (Firebase removes empty arrays)
            const cleaned = data.map(p => ({ ...p, tasks: p.tasks || [] }));
            skipNextSave.current = true;
            setProjects(cleaned);
            if (isFirstLoad.current) {
              setSelectedProject(cleaned[0].id);
              isFirstLoad.current = false;
            }
            setCloudStatus('synced');
          } else if (isFirstLoad.current) {
            // Database is empty: create demo project
            const demo = createDemoProject();
            const initial = [demo];
            setProjects(initial);
            setSelectedProject(demo.id);
            saveToFirebase(initial);
            isFirstLoad.current = false;
            setCloudStatus('synced');
          }
        };

        const handleError = (error) => {
          console.error('Firebase error:', error);
          setCloudStatus('offline');
          // Fallback to localStorage
          if (isFirstLoad.current) {
            const saved = localStorage.getItem('projectflow-projects');
            if (saved) {
              try {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed) && parsed.length > 0) {
                  setProjects(parsed);
                  setSelectedProject(parsed[0].id);
                  isFirstLoad.current = false;
                  return;
                }
              } catch (e) {}
            }
            const demo = createDemoProject();
            setProjects([demo]);
            setSelectedProject(demo.id);
            isFirstLoad.current = false;
          }
        };

        projectsRef.on('value', handleData, handleError);

        // Monitor connection status
        const connRef = db.ref('.info/connected');
        const connHandler = (snap) => {
          if (snap.val() === true) {
            setCloudStatus('synced');
          } else {
            setCloudStatus('offline');
          }
        };
        connRef.on('value', connHandler);

        // Team sync
        const teamRef = db.ref('team');
        const handleTeamData = (snapshot) => {
          const data = snapshot.val();
          if (data && Array.isArray(data)) {
            skipNextTeamSave.current = true;
            setTeam(data);
          }
        };
        teamRef.on('value', handleTeamData);

        // Email config sync
        const emailRef = db.ref('emailConfig');
        const handleEmailConfig = (snapshot) => {
          const data = snapshot.val();
          if (data) setEmailConfig(data);
        };
        emailRef.on('value', handleEmailConfig);

        // Time logs sync
        const timeRef = db.ref('timeLogs');
        const handleTimeLogs = (snapshot) => {
          const data = snapshot.val();
          if (data && Array.isArray(data)) {
            skipNextTimeSave.current = true;
            setTimeLogs(data);
          }
        };
        timeRef.on('value', handleTimeLogs);

        return () => {
          projectsRef.off('value', handleData);
          connRef.off('value', connHandler);
          teamRef.off('value', handleTeamData);
          emailRef.off('value', handleEmailConfig);
          timeRef.off('value', handleTimeLogs);
        };
      }, []);

      // Timer tick - update every second when timer is active
      useEffect(() => {
        if (!activeTimer) return;
        const interval = setInterval(() => setTimerTick(t => t + 1), 1000);
        return () => clearInterval(interval);
      }, [activeTimer]);

      // Keyboard shortcuts
      useEffect(() => {
        const handler = (e) => {
          // Skip if user is typing in an input/textarea/contenteditable
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
          const key = e.key.toLowerCase();
          if (key === '1') setView('gantt');
          else if (key === '2') setView('list');
          else if (key === '3') setView('kanban');
          else if (key === '4') setView('calendar');
          else if (key === '5') setView('dashboard');
          else if (key === 'n' && !e.ctrlKey && !e.metaKey) setShowNewTask(true);
          else if (key === 'e') setShowTeamManager(v => !v);
          else if (key === 't') setShowTimesheet(v => !v);
          else if (key === 'k' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            setShowGlobalSearch(v => !v);
          }
          else if (key === '?') {
            e.preventDefault();
            showToast('Atalhos: 1-5=Views | N=Nova | E=Equipe | T=Timesheet | Ctrl+K=Busca global', 'info');
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      // Save time logs to Firebase
      useEffect(() => {
        if (skipNextTimeSave.current) {
          skipNextTimeSave.current = false;
          return;
        }
        if (timeLogs.length > 0) {
          saveTimeLogsToFirebase(timeLogs);
        }
      }, [timeLogs]);

      // Start/Stop timer
      const startTimer = (taskId, projectId) => {
        setActiveTimer({ taskId, projectId, startTime: Date.now() });
        setTimerTick(0);
      };

      const stopTimer = () => {
        if (!activeTimer) return;
        const elapsed = Math.floor((Date.now() - activeTimer.startTime) / 1000);
        if (elapsed < 5) { setActiveTimer(null); return; } // Ignore < 5 seconds
        const project = projects.find(p => p.id === activeTimer.projectId);
        const task = project?.tasks?.find(t => t.id === activeTimer.taskId);
        const log = {
          id: Date.now(),
          taskId: activeTimer.taskId,
          taskName: task?.name || 'Tarefa',
          projectId: activeTimer.projectId,
          projectName: project?.name || 'Projeto',
          assignee: task?.assignee || '',
          date: new Date().toISOString().split('T')[0],
          seconds: elapsed,
        };
        setTimeLogs(prev => [...prev, log]);
        setActiveTimer(null);
        showToast(`${formatHours(elapsed)} registrado em "${log.taskName}"`, 'success');
      };

      // Add manual time log
      const addManualTimeLog = (log) => {
        setTimeLogs(prev => [...prev, { id: Date.now(), ...log }]);
        showToast(`${formatHours(log.seconds)} registrado manualmente`, 'success');
      };

      const deleteTimeLog = (logId) => {
        setTimeLogs(prev => prev.filter(l => l.id !== logId));
      };

      // Save team to Firebase when it changes
      useEffect(() => {
        if (skipNextTeamSave.current) {
          skipNextTeamSave.current = false;
          return;
        }
        if (team.length > 0 || !isFirstLoad.current) {
          saveTeamToFirebase(team);
        }
      }, [team]);

      // Save to Firebase + localStorage whenever projects change
      useEffect(() => {
        if (isFirstLoad.current) return;
        if (skipNextSave.current) {
          skipNextSave.current = false;
          return;
        }
        // Save to both Firebase and localStorage
        saveToFirebase(projects);
        localStorage.setItem('projectflow-projects', JSON.stringify(projects));
      }, [projects]);

      const currentProject = projects.find(p => p.id === selectedProject);

      // Filtered tasks
      const filteredTasks = useMemo(() => {
        if (!currentProject) return [];
        return currentProject.tasks.filter(task => {
          const matchesSearch = !searchQuery ||
            task.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            (task.assignee && task.assignee.toLowerCase().includes(searchQuery.toLowerCase())) ||
            (task.description && task.description.toLowerCase().includes(searchQuery.toLowerCase())) ||
            (task.tags && task.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase())));
          const matchesStatus = statusFilter === 'all' || task.status === statusFilter ||
            (statusFilter === 'overdue' && isOverdue(task));
          const matchesPriority = priorityFilter === 'all' || (task.priority || 'medium') === priorityFilter;
          return matchesSearch && matchesStatus && matchesPriority;
        });
      }, [currentProject, searchQuery, statusFilter, priorityFilter]);

      // Sorted tasks
      const sortedTasks = useMemo(() => {
        if (sortBy === 'default') return filteredTasks;
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        const statusOrder = { 'in-progress': 0, pending: 1, completed: 2 };
        return [...filteredTasks].sort((a, b) => {
          if (sortBy === 'name') return a.name.localeCompare(b.name);
          if (sortBy === 'date') return new Date(a.end) - new Date(b.end);
          if (sortBy === 'priority') return (priorityOrder[a.priority || 'medium']) - (priorityOrder[b.priority || 'medium']);
          if (sortBy === 'status') return (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
          if (sortBy === 'progress') return b.progress - a.progress;
          return 0;
        });
      }, [filteredTasks, sortBy]);

      // Project with filtered tasks for views
      const filteredProject = useMemo(() => {
        if (!currentProject) return null;
        return { ...currentProject, tasks: sortedTasks };
      }, [currentProject, sortedTasks]);

      const addProject = (projectData) => {
        const newProject = {
          id: Date.now(),
          name: projectData.name,
          client: projectData.client || '',
          description: projectData.description || '',
          briefing: projectData.briefing || '',
          color: projectData.color,
          deadline: projectData.deadline || '',
          status: 'active',
          tasks: []
        };
        setProjects(prev => [...prev, newProject]);
        setSelectedProject(newProject.id);
        setShowNewProject(false);
        showToast(`Projeto "${projectData.name}" criado`, 'success');
        addActivity('Projeto criado', projectData.name);
      };

      const updateProject = (projectId, updates) => {
        setProjects(prev => prev.map(p => p.id === projectId ? { ...p, ...updates } : p));
      };

      const deleteProject = (id) => {
        setProjects(prev => {
          const updated = prev.filter(p => p.id !== id);
          if (selectedProject === id) {
            setSelectedProject(updated.length > 0 ? updated[0].id : null);
          }
          return updated;
        });
        showToast('Projeto deletado', 'info');
        addActivity('Projeto deletado', '');
      };

      const addTask = (taskData) => {
        const newTask = {
          id: Date.now(),
          progress: 0,
          status: 'pending',
          ...taskData,
        };

        setProjects(projects.map(p =>
          p.id === selectedProject
            ? { ...p, tasks: [...p.tasks, newTask] }
            : p
        ));
        setShowNewTask(false);
        showToast(`Tarefa "${taskData.name}" criada`, 'success');
        addActivity('Tarefa criada', taskData.name);

        // Send email notification to assignee
        if (taskData.assignee && team.length > 0) {
          const member = team.find(m => m.name === taskData.assignee);
          if (member && member.email) {
            const projectName = currentProject ? currentProject.name : '';
            const sent = sendTaskEmail(emailConfig, member, { ...taskData, ...newTask }, projectName);
            if (sent) showToast(`Email enviado para ${member.name}`, 'info');
          }
        }
      };

      const updateTask = (taskId, updates) => {
        setProjects(projects.map(p =>
          p.id === selectedProject
            ? {
                ...p,
                tasks: p.tasks.map(t =>
                  t.id === taskId ? { ...t, ...updates } : t
                )
              }
            : p
        ));
      };

      const deleteTask = (taskId) => {
        setProjects(projects.map(p =>
          p.id === selectedProject
            ? { ...p, tasks: p.tasks.filter(t => t.id !== taskId) }
            : p
        ));
        showToast('Tarefa removida', 'info');
        addActivity('Tarefa removida', '');
      };

      const duplicateTask = (task) => {
        const newTask = {
          ...task,
          id: Date.now(),
          name: `${task.name} (c√≥pia)`,
          status: 'pending',
          progress: 0,
        };
        setProjects(projects.map(p =>
          p.id === selectedProject
            ? { ...p, tasks: [...p.tasks, newTask] }
            : p
        ));
        showToast(`Tarefa duplicada: "${newTask.name}"`, 'success');
        addActivity('Tarefa duplicada', newTask.name);
      };

      // Export projects as JSON
      const exportData = () => {
        const data = JSON.stringify(projects, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `projectflow-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup exportado com sucesso', 'success');
      };

      // Import projects from JSON
      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const parsed = JSON.parse(ev.target.result);
            if (Array.isArray(parsed) && parsed.length > 0) {
              setProjects(parsed);
              setSelectedProject(parsed[0].id);
              showToast(`${parsed.length} projeto(s) importado(s)`, 'success');
            } else {
              showToast('Arquivo inv√°lido', 'error');
            }
          } catch {
            showToast('Erro ao ler arquivo JSON', 'error');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      };

      // Stats for current project
      const projectStats = useMemo(() => {
        if (!currentProject || currentProject.tasks.length === 0) return null;
        const tasks = currentProject.tasks;
        const total = tasks.length;
        const completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        const pending = tasks.filter(t => t.status === 'pending').length;
        const overdue = tasks.filter(t => isOverdue(t)).length;
        const avgProgress = Math.round(tasks.reduce((a, t) => a + t.progress, 0) / total);
        return { total, completed, inProgress, pending, overdue, avgProgress };
      }, [currentProject]);

      // Show loading skeleton while Firebase connects
      if (isFirstLoad.current && projects.length === 0) {
        return <LoadingSkeleton />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white font-sans">
          {/* Header - Clean top bar */}
          <header className="border-b border-white/10 sticky top-0 z-30 no-print" style={{ background: (appSettings.bgColor || '#0f172a') + 'ee', backdropFilter: 'blur(12px)' }}>
            <div className="flex items-center justify-between px-4 h-14">
              <div className="flex items-center gap-3">
                <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 hover:bg-white/10 rounded-lg transition" aria-label="Menu">
                  <Menu className="w-5 h-5" />
                </button>
                <div className="flex items-center gap-2.5">
                  {appSettings.logoUrl ? (
                    <img src={appSettings.logoUrl} alt="Logo" className="h-8 w-auto" />
                  ) : (
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm" style={{ background: appSettings.primaryColor || 'var(--pf-primary)' }}>
                      {(appSettings.companyName || 'P')[0]}
                    </div>
                  )}
                  <span className="font-semibold text-sm hidden sm:block">{appSettings.companyName || 'ProjectFlow'}</span>
                </div>
              </div>
              <button onClick={() => setShowGlobalSearch(true)} className="hidden sm:flex items-center gap-2 px-4 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition text-slate-400 text-sm w-72">
                <Search className="w-4 h-4 flex-shrink-0" />
                <span>Buscar...</span>
                <kbd className="ml-auto text-[10px] text-slate-500 bg-white/5 px-1.5 py-0.5 rounded">Ctrl+K</kbd>
              </button>
              <div className="flex items-center gap-1">
                <button onClick={() => setShowGlobalSearch(true)} className="sm:hidden p-2 hover:bg-white/10 rounded-lg transition text-slate-400" title="Buscar"><Search className="w-4 h-4" /></button>
                <button onClick={() => setShowTeamManager(true)} className="p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Equipe"><Users className="w-4 h-4" /></button>
                <button onClick={() => setShowTimesheet(true)} className="p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Timesheet"><Clock className="w-4 h-4" /></button>
                <button onClick={() => setShowActivityLog(true)} className="relative p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Log">
                  <AlertTriangle className="w-4 h-4" />
                  {activityLog.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 rounded-full" style={{ background: appSettings.primaryColor || 'var(--pf-primary)' }} />}
                </button>
                <CloudStatusBadge status={cloudStatus} />
                <div className="w-px h-5 bg-white/10 mx-1 hidden sm:block" />
                <button onClick={exportData} className="hidden sm:block p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Exportar"><Download className="w-4 h-4" /></button>
                <button onClick={() => fileInputRef.current?.click()} className="hidden sm:block p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Importar"><Upload className="w-4 h-4" /></button>
                <input ref={fileInputRef} type="file" accept=".json" onChange={importData} className="hidden" />
                <div className="w-px h-5 bg-white/10 mx-1 hidden sm:block" />
                <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Configuracoes"><SettingsIcon className="w-4 h-4" /></button>
              </div>
            </div>
          </header>

          {/* Settings Modal */}
          {showSettings && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" onClick={(e) => { if (e.target === e.currentTarget) setShowSettings(false); }}>
              <div className="glass rounded-2xl max-w-2xl w-full max-h-[85vh] flex flex-col animate-scale-in">
                <div className="flex items-center justify-between p-6 pb-4 border-b border-white/10 flex-shrink-0">
                  <div className="flex items-center gap-3">
                    <SettingsIcon className="w-5 h-5 text-slate-400" />
                    <h2 className="text-xl font-bold">Configuracoes</h2>
                  </div>
                  <button onClick={() => setShowSettings(false)} className="p-1 hover:bg-white/10 rounded-lg transition"><X className="w-5 h-5" /></button>
                </div>
                <div className="overflow-y-auto flex-1 p-6 space-y-8">
                  <div>
                    <h3 className="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-4"><Palette className="w-4 h-4" /> Personalizacao / White Label</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">Nome da Empresa</label>
                        <input type="text" value={appSettings.companyName || ''} onChange={(e) => setAppSettings(s => ({...s, companyName: e.target.value}))} placeholder="ProjectFlow" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">Slogan / Descricao</label>
                        <input type="text" value={appSettings.companyTagline || ''} onChange={(e) => setAppSettings(s => ({...s, companyTagline: e.target.value}))} placeholder="Gestao Visual de Projetos" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">URL do Logotipo</label>
                        <input type="url" value={appSettings.logoUrl || ''} onChange={(e) => setAppSettings(s => ({...s, logoUrl: e.target.value}))} placeholder="https://suaempresa.com/logo.png" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                        {appSettings.logoUrl && <img src={appSettings.logoUrl} alt="Preview" className="mt-2 h-10 w-auto rounded bg-white/5 p-1" />}
                      </div>
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Cor Primaria</label>
                          <div className="flex items-center gap-2">
                            <input type="color" value={appSettings.primaryColor || '#06b6d4'} onChange={(e) => setAppSettings(s => ({...s, primaryColor: e.target.value}))} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
                            <input type="text" value={appSettings.primaryColor || '#06b6d4'} onChange={(e) => setAppSettings(s => ({...s, primaryColor: e.target.value}))} className="flex-1 px-2 py-1.5 bg-white/5 border border-white/10 rounded text-xs font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                          </div>
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Cor Destaque</label>
                          <div className="flex items-center gap-2">
                            <input type="color" value={appSettings.accentColor || '#3b82f6'} onChange={(e) => setAppSettings(s => ({...s, accentColor: e.target.value}))} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
                            <input type="text" value={appSettings.accentColor || '#3b82f6'} onChange={(e) => setAppSettings(s => ({...s, accentColor: e.target.value}))} className="flex-1 px-2 py-1.5 bg-white/5 border border-white/10 rounded text-xs font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                          </div>
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Cor Fundo</label>
                          <div className="flex items-center gap-2">
                            <input type="color" value={appSettings.bgColor || '#0f172a'} onChange={(e) => setAppSettings(s => ({...s, bgColor: e.target.value}))} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
                            <input type="text" value={appSettings.bgColor || '#0f172a'} onChange={(e) => setAppSettings(s => ({...s, bgColor: e.target.value}))} className="flex-1 px-2 py-1.5 bg-white/5 border border-white/10 rounded text-xs font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                          </div>
                        </div>
                      </div>
                      <div className="p-3 rounded-lg border border-white/10" style={{ background: (appSettings.bgColor || '#0f172a') + '99' }}>
                        <p className="text-xs text-slate-400 mb-2">Preview:</p>
                        <div className="flex items-center gap-2">
                          {appSettings.logoUrl ? <img src={appSettings.logoUrl} alt="" className="h-6" /> : <div className="w-6 h-6 rounded flex items-center justify-center text-white text-xs font-bold" style={{ background: appSettings.primaryColor || '#06b6d4' }}>{(appSettings.companyName || 'P')[0]}</div>}
                          <span className="font-semibold text-sm">{appSettings.companyName || 'ProjectFlow'}</span>
                          <span className="ml-auto px-2 py-0.5 rounded text-xs text-white" style={{ background: appSettings.primaryColor || '#06b6d4' }}>Botao</span>
                          <span className="px-2 py-0.5 rounded text-xs text-white" style={{ background: appSettings.accentColor || '#3b82f6' }}>Destaque</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div>
                    <h3 className="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-4"><LinkIcon className="w-4 h-4" /> Integracoes</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">EmailJS - Service ID</label>
                        <input type="text" value={emailConfig.serviceId} onChange={(e) => setEmailConfig(c => ({...c, serviceId: e.target.value}))} placeholder="service_xxxxxx" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">EmailJS - Template ID</label>
                        <input type="text" value={emailConfig.templateId} onChange={(e) => setEmailConfig(c => ({...c, templateId: e.target.value}))} placeholder="template_xxxxxx" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-1">EmailJS - Public Key</label>
                        <input type="text" value={emailConfig.publicKey} onChange={(e) => setEmailConfig(c => ({...c, publicKey: e.target.value}))} placeholder="xxxxxxxxx" className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
                      </div>
                      <div className="p-3 rounded-lg bg-white/5 border border-white/10">
                        <p className="text-xs text-slate-400 mb-1">Firebase</p>
                        <p className="text-xs text-slate-500 font-mono">Projeto: projectflow-e22cc</p>
                        <p className="text-xs text-emerald-400 mt-1">Status: {cloudStatus === 'synced' ? 'Conectado' : cloudStatus === 'connecting' ? 'Conectando...' : 'Offline'}</p>
                      </div>
                    </div>
                  </div>
                  <div>
                    <h3 className="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-4"><SettingsIcon className="w-4 h-4" /> Geral</h3>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                        <div>
                          <p className="text-sm">Atalhos de Teclado</p>
                          <p className="text-xs text-slate-500">1-5 Views | N Nova | E Equipe | T Timesheet | Ctrl+K Busca | ? Ajuda</p>
                        </div>
                      </div>
                      <div className="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                        <div>
                          <p className="text-sm">Dados</p>
                          <p className="text-xs text-slate-500">{projects.length} projeto(s) | {projects.reduce((a,p) => a + p.tasks.length, 0)} tarefa(s) | {team.length} membro(s)</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => { exportData(); }} className="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition">Exportar</button>
                          <button onClick={() => fileInputRef.current?.click()} className="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition">Importar</button>
                        </div>
                      </div>
                      <button onClick={() => { setAppSettings({ companyName: 'ProjectFlow', companyTagline: 'Gestao Visual de Projetos', logoUrl: '', primaryColor: '#06b6d4', accentColor: '#3b82f6', bgColor: '#0f172a' }); showToast('Configuracoes restauradas', 'success'); }} className="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-xs transition">
                        Restaurar Padroes
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Active timer bar */}
          {activeTimer && (() => {
            const project = projects.find(p => p.id === activeTimer.projectId);
            const task = project?.tasks?.find(t => t.id === activeTimer.taskId);
            const elapsed = Math.floor((Date.now() - activeTimer.startTime) / 1000);
            return (
              <div className="bg-emerald-500/10 border-b border-emerald-500/20 sticky top-[60px] z-20">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 py-2 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
                    <span className="text-sm text-emerald-300">
                      Timer ativo: <strong>{task?.name || 'Tarefa'}</strong>
                      <span className="text-emerald-400/60 ml-1">({project?.name})</span>
                    </span>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="font-mono text-emerald-400 font-bold text-sm">{formatTime(elapsed)}</span>
                    <button onClick={stopTimer} className="flex items-center gap-1.5 px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-xs font-medium transition">
                      <Square className="w-3 h-3" /> Parar
                    </button>
                  </div>
                </div>
              </div>
            );
          })()}

          <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
            <div className="flex gap-6">
              {/* Sidebar - Projects (Desktop) */}
              <aside className="hidden lg:block w-72 flex-shrink-0 animate-slide-in no-print" style={{ animationDelay: '0.1s' }}>
                <ProjectSidebar
                  projects={projects}
                  selectedProject={selectedProject}
                  onSelectProject={setSelectedProject}
                  onDeleteProject={deleteProject}
                  showNewProject={showNewProject}
                  onToggleNewProject={setShowNewProject}
                  onAddProject={addProject}
                  onEditProject={setEditingProject}
                  projectFilter={projectFilter}
                  setProjectFilter={setProjectFilter}
                  showConfirm={showConfirm}
                />
              </aside>

              {/* Sidebar - Projects (Mobile) */}
              {sidebarOpen && (
                <div className="sidebar-overlay lg:hidden" onClick={() => setSidebarOpen(false)} />
              )}
              <aside className={`sidebar-panel lg:hidden ${sidebarOpen ? 'open' : ''} bg-slate-900 p-4`}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">Projetos</h2>
                  <button onClick={() => setSidebarOpen(false)} className="p-2 hover:bg-white/10 rounded-lg" aria-label="Fechar menu">
                    <X className="w-5 h-5" />
                  </button>
                </div>
                <ProjectSidebar
                  projects={projects}
                  selectedProject={selectedProject}
                  onSelectProject={(id) => { setSelectedProject(id); setSidebarOpen(false); }}
                  onDeleteProject={deleteProject}
                  showNewProject={showNewProject}
                  onToggleNewProject={setShowNewProject}
                  onAddProject={addProject}
                  onEditProject={setEditingProject}
                  projectFilter={projectFilter}
                  setProjectFilter={setProjectFilter}
                  showConfirm={showConfirm}
                />
              </aside>

              {/* Main Content */}
              <main className="flex-1 min-w-0 animate-slide-in" style={{ animationDelay: '0.2s' }}>
                {currentProject ? (
                  <>
                    {/* Project Header with Stats */}
                    <div className="glass rounded-2xl p-4 sm:p-6 mb-6">
                      <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-1">
                            <h2 className="text-2xl sm:text-3xl font-bold">{currentProject.name}</h2>
                            <button onClick={() => setEditingProject(currentProject)} className="p-1.5 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white" title="Editar projeto" aria-label="Editar projeto">
                              <Edit2 className="w-4 h-4" />
                            </button>
                            <button onClick={() => window.print()} className="p-1.5 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white no-print" title="Imprimir relat√≥rio" aria-label="Imprimir relat√≥rio">
                              <Download className="w-4 h-4" />
                            </button>
                          </div>
                          {currentProject.client && (
                            <div className="text-sm text-slate-400 mb-1">Cliente: <span className="text-slate-300">{currentProject.client}</span></div>
                          )}
                          {currentProject.description && (
                            <div className="text-sm text-slate-400 mb-2">{currentProject.description}</div>
                          )}
                          {currentProject.deadline && (
                            <div className="text-xs text-slate-500 mb-2 font-mono">Prazo: {new Date(currentProject.deadline).toLocaleDateString('pt-BR')}</div>
                          )}
                          {projectStats && (
                            <div className="flex flex-wrap items-center gap-3 text-sm">
                              <span className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 font-mono text-slate-300">
                                {projectStats.total} tarefas
                              </span>
                              <span className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-emerald-500/15 text-emerald-400 font-mono">
                                {projectStats.completed} conclu√≠das
                              </span>
                              {projectStats.overdue > 0 && (
                                <span className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-red-500/15 text-red-400 font-mono">
                                  <AlertTriangle className="w-3 h-3" />
                                  {projectStats.overdue} atrasada{projectStats.overdue > 1 ? 's' : ''}
                                </span>
                              )}
                              <span className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-cyan-500/15 text-cyan-400 font-mono">
                                {projectStats.avgProgress}% progresso
                              </span>
                            </div>
                          )}

                          {/* Overall progress bar */}
                          {projectStats && (
                            <div className="mt-4 flex items-center gap-3">
                              <div className="flex-1 h-2.5 bg-white/10 rounded-full overflow-hidden">
                                <div
                                  className="h-full rounded-full transition-all duration-700 ease-out"
                                  style={{
                                    width: `${projectStats.avgProgress}%`,
                                    background: projectStats.avgProgress >= 80 ? 'linear-gradient(90deg, #10b981, #34d399)' : projectStats.avgProgress >= 40 ? 'linear-gradient(90deg, #06b6d4, #3b82f6)' : 'linear-gradient(90deg, #f59e0b, #f97316)'
                                  }}
                                />
                              </div>
                              <span className="text-xs font-mono text-slate-400 w-10 text-right">{projectStats.avgProgress}%</span>
                            </div>
                          )}
                        </div>
                        <button
                          onClick={() => setShowNewTask(true)}
                          className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg text-sm font-semibold hover:shadow-lg hover:shadow-cyan-500/50 transition flex items-center gap-2 whitespace-nowrap self-start"
                        >
                          <Plus className="w-4 h-4" />
                          Nova Tarefa
                        </button>
                      </div>
                    </div>

                    {/* Briefing section */}
                    {currentProject.briefing && (
                      <BriefingDisplay briefing={currentProject.briefing} />
                    )}

                    {/* Search and Filter Bar */}
                    {currentProject.tasks.length > 0 && (
                      <div className="glass rounded-xl p-3 mb-4 flex flex-col sm:flex-row gap-3 no-print">
                        <div className="relative flex-1" role="search">
                          <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                          <input
                            type="text"
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            placeholder="Buscar tarefas, respons√°veis..."
                            aria-label="Buscar tarefas"
                            className="w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50 placeholder-slate-500"
                          />
                          {searchQuery && (
                            <button onClick={() => setSearchQuery('')} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
                              <X className="w-3 h-3" />
                            </button>
                          )}
                        </div>
                        <select
                          value={sortBy}
                          onChange={(e) => setSortBy(e.target.value)}
                          className="bg-white/5 border border-white/10 rounded-lg px-2.5 py-1.5 text-xs text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 self-start"
                          aria-label="Ordenar tarefas"
                        >
                          <option value="default" className="bg-slate-800">Ordenar por...</option>
                          <option value="name" className="bg-slate-800">Nome (A-Z)</option>
                          <option value="date" className="bg-slate-800">Prazo (mais pr√≥ximo)</option>
                          <option value="priority" className="bg-slate-800">Prioridade (maior)</option>
                          <option value="status" className="bg-slate-800">Status</option>
                          <option value="progress" className="bg-slate-800">Progresso (maior)</option>
                        </select>
                        <div className="flex gap-1 bg-white/5 rounded-lg p-1 self-start">
                          {[
                            { value: 'all', label: 'Todas' },
                            { value: 'pending', label: 'Pendente' },
                            { value: 'in-progress', label: 'Em Progresso' },
                            { value: 'completed', label: 'Conclu√≠da' },
                            { value: 'overdue', label: 'Atrasada' },
                          ].map(f => (
                            <button
                              key={f.value}
                              onClick={() => setStatusFilter(f.value)}
                              className={`px-2.5 py-1 rounded-md text-xs font-medium transition ${
                                statusFilter === f.value
                                  ? 'bg-cyan-500 text-white'
                                  : 'text-slate-400 hover:text-white hover:bg-white/10'
                              }`}
                            >
                              {f.label}
                            </button>
                          ))}
                        </div>
                        <div className="flex gap-1 bg-white/5 rounded-lg p-1 self-start">
                          {[
                            { value: 'all', label: 'Todas', icon: '' },
                            { value: 'high', label: 'üî¥ Alta', icon: '' },
                            { value: 'medium', label: 'üü° M√©dia', icon: '' },
                            { value: 'low', label: 'üü¢ Baixa', icon: '' },
                          ].map(f => (
                            <button
                              key={f.value}
                              onClick={() => setPriorityFilter(f.value)}
                              className={`px-2.5 py-1 rounded-md text-xs font-medium transition ${
                                priorityFilter === f.value
                                  ? 'bg-cyan-500 text-white'
                                  : 'text-slate-400 hover:text-white hover:bg-white/10'
                              }`}
                            >
                              {f.label}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {showNewTask && (
                      <div className="glass rounded-2xl p-6 mb-6 animate-scale-in">
                        <div className="mb-4">
                          <span className="text-xs text-slate-500 block mb-2">Templates r√°pidos:</span>
                          <div className="flex flex-wrap gap-2">
                            {[
                              { label: 'üìê Design', data: { name: 'Design', priority: 'high', tags: ['design'] } },
                              { label: 'üíª Desenvolvimento', data: { name: 'Desenvolvimento', priority: 'high', tags: ['dev'] } },
                              { label: '‚úÖ Revis√£o', data: { name: 'Revis√£o e aprova√ß√£o', priority: 'medium', tags: ['revisao'] } },
                              { label: 'üìù Conte√∫do', data: { name: 'Produ√ß√£o de conte√∫do', priority: 'medium', tags: ['conteudo'] } },
                              { label: 'üêõ Bug Fix', data: { name: 'Corre√ß√£o de bug', priority: 'high', tags: ['bug'] } },
                              { label: 'üìä Relat√≥rio', data: { name: 'Relat√≥rio', priority: 'low', tags: ['relatorio'] } },
                            ].map((tpl, i) => (
                              <button key={i} type="button" onClick={() => {
                                const today = new Date().toISOString().split('T')[0];
                                const nextWeek = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
                                addTask({ ...tpl.data, start: today, end: nextWeek, assignee: '', status: 'pending', progress: 0, dependencies: [] });
                              }}
                              className="px-2.5 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs text-slate-300 hover:text-white transition">
                                {tpl.label}
                              </button>
                            ))}
                          </div>
                        </div>
                        <TaskForm
                          onSave={addTask}
                          onCancel={() => setShowNewTask(false)}
                          existingTasks={currentProject.tasks}
                          team={team}
                        />
                      </div>
                    )}

                    {/* Overdue tasks warning */}
                    {projectStats && projectStats.overdue > 0 && statusFilter === 'all' && (
                      <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-3 animate-fade-in">
                        <AlertTriangle className="w-5 h-5 text-red-400 flex-shrink-0" />
                        <div className="flex-1">
                          <span className="text-sm text-red-300 font-medium">{projectStats.overdue} tarefa{projectStats.overdue > 1 ? 's' : ''} atrasada{projectStats.overdue > 1 ? 's' : ''}!</span>
                          <span className="text-xs text-red-400/70 ml-2">Clique em "Atrasada" no filtro para ver</span>
                        </div>
                        <button onClick={() => setStatusFilter('overdue')} className="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-xs font-medium transition">
                          Ver atrasadas
                        </button>
                      </div>
                    )}

                    {/* Views */}
                    <div key={view} className="animate-view-transition">
                    {view === 'gantt' && (
                      <GanttView
                        project={filteredProject}
                        onUpdateTask={updateTask}
                        onDeleteTask={deleteTask}
                        onEditTask={setEditingTask}
                        onDuplicateTask={duplicateTask}
                        showConfirm={showConfirm}
                      />
                    )}
                    {view === 'list' && (
                      <ListView
                        project={filteredProject}
                        onUpdateTask={updateTask}
                        onDeleteTask={deleteTask}
                        onEditTask={setEditingTask}
                        onDuplicateTask={duplicateTask}
                        activeTimer={activeTimer}
                        onStartTimer={startTimer}
                        onStopTimer={stopTimer}
                        showConfirm={showConfirm}
                      />
                    )}
                    {view === 'kanban' && (
                      <KanbanView
                        project={filteredProject}
                        onUpdateTask={updateTask}
                        onDeleteTask={deleteTask}
                        onEditTask={setEditingTask}
                        onDuplicateTask={duplicateTask}
                        activeTimer={activeTimer}
                        onStartTimer={startTimer}
                        onStopTimer={stopTimer}
                        showConfirm={showConfirm}
                      />
                    )}
                    {view === 'calendar' && (
                      <CalendarView
                        project={filteredProject}
                        onEditTask={setEditingTask}
                      />
                    )}
                    {view === 'dashboard' && currentProject && (
                      <DashboardView project={currentProject} timeLogs={timeLogs} team={team} />
                    )}
                    </div>

                    {/* Filter results info */}
                    {(searchQuery || statusFilter !== 'all' || priorityFilter !== 'all') && currentProject.tasks.length > 0 && (
                      <div className="mt-3 text-xs text-slate-500 text-center">
                        Mostrando {filteredTasks.length} de {currentProject.tasks.length} tarefas
                        {searchQuery && <span> para "{searchQuery}"</span>}
                      </div>
                    )}

                    {editingTask && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" onClick={(e) => { if (e.target === e.currentTarget) setEditingTask(null); }}>
                        <div className="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] flex flex-col animate-scale-in">
                          <div className="flex items-center justify-between mb-4 flex-shrink-0">
                            <h3 className="text-xl font-bold">Editar Tarefa</h3>
                            <button onClick={() => setEditingTask(null)} className="p-1 hover:bg-white/10 rounded-lg transition">
                              <X className="w-5 h-5" />
                            </button>
                          </div>
                          <div className="overflow-y-auto flex-1 pr-1">
                          <TaskForm
                            initialData={editingTask}
                            onSave={(data) => {
                              updateTask(editingTask.id, data);
                              setEditingTask(null);
                              showToast('Tarefa atualizada', 'success');
                            }}
                            onCancel={() => setEditingTask(null)}
                            existingTasks={currentProject.tasks}
                            team={team}
                            isEditing
                          />
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                ) : (
                  <div className="glass rounded-2xl p-12 text-center">
                    <Calendar className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                    <h3 className="text-xl font-semibold mb-2">Nenhum projeto selecionado</h3>
                    <p className="text-slate-400 mb-4">Crie um novo projeto para come√ßar</p>
                    <button
                      onClick={() => { setShowNewProject(true); setSidebarOpen(true); }}
                      className="px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg text-sm font-semibold hover:shadow-lg transition"
                    >
                      Criar Projeto
                    </button>
                  </div>
                )}
              </main>
            </div>
          </div>

          {/* Edit Project Modal */}
          {editingProject && (
            <EditProjectModal
              project={editingProject}
              onSave={(updates) => { updateProject(editingProject.id, updates); setEditingProject(null); showToast('Projeto atualizado', 'success'); }}
              onClose={() => setEditingProject(null)}
            />
          )}

          {/* Timesheet Modal */}
          {showTimesheet && (
            <TimesheetPanel
              timeLogs={timeLogs}
              projects={projects}
              team={team}
              onAddLog={addManualTimeLog}
              onDeleteLog={deleteTimeLog}
              onClose={() => setShowTimesheet(false)}
              showConfirm={showConfirm}
            />
          )}

          {/* Team Manager Modal */}
          {showTeamManager && (
            <TeamManager
              team={team}
              setTeam={setTeam}
              emailConfig={emailConfig}
              setEmailConfig={(config) => { setEmailConfig(config); saveEmailConfigToFirebase(config); }}
              onClose={() => setShowTeamManager(false)}
              showToast={showToast}
              showConfirm={showConfirm}
            />
          )}

          {/* Keyboard shortcut hint */}
          <div className="fixed bottom-4 left-4 text-xs text-slate-600 font-mono hidden lg:block">
            Esc fechar | Ctrl+N nova tarefa
          </div>

          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          {confirmModal && <ConfirmModal message={confirmModal.message} onConfirm={() => { confirmModal.onConfirm(); setConfirmModal(null); }} onCancel={() => setConfirmModal(null)} />}
          {showGlobalSearch && <GlobalSearch projects={projects} onSelect={(projectId, task) => { setSelectedProject(projectId); if (task) setEditingTask(task); }} onClose={() => setShowGlobalSearch(false)} />}

          {/* Activity Log Modal */}
          {showActivityLog && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={() => setShowActivityLog(false)}>
              <div className="glass rounded-2xl p-6 max-w-md w-full mx-4 max-h-[80vh] flex flex-col animate-scale-in" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-bold">Atividades Recentes</h2>
                  <button onClick={() => setShowActivityLog(false)} className="p-1 hover:bg-white/10 rounded-lg transition"><X className="w-5 h-5" /></button>
                </div>
                <div className="flex-1 overflow-y-auto space-y-2">
                  {activityLog.length === 0 ? (
                    <p className="text-slate-500 text-sm text-center py-8">Nenhuma atividade registrada nesta sess√£o</p>
                  ) : activityLog.map(a => (
                    <div key={a.id} className="flex items-start gap-3 py-2 border-b border-white/5">
                      <div className="w-2 h-2 rounded-full bg-cyan-500 mt-1.5 flex-shrink-0" />
                      <div className="flex-1 min-w-0">
                        <div className="text-sm text-slate-200">{a.action}</div>
                        {a.detail && <div className="text-xs text-slate-400 truncate">{a.detail}</div>}
                        <div className="text-xs text-slate-600 mt-0.5">{new Date(a.time).toLocaleTimeString('pt-BR')}</div>
                      </div>
                    </div>
                  ))}
                </div>
                {activityLog.length > 0 && (
                  <button onClick={() => { setActivityLog([]); setShowActivityLog(false); }} className="mt-3 text-xs text-slate-500 hover:text-slate-300 transition">Limpar hist√≥rico</button>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    // Project Sidebar Component (extracted for desktop/mobile reuse)
    function GlobalSearch({ projects, onSelect, onClose }) {
      const [query, setQuery] = useState('');
      const inputRef = useRef(null);

      useEffect(() => { inputRef.current?.focus(); }, []);

      const results = useMemo(() => {
        if (!query.trim()) return [];
        const q = query.toLowerCase();
        const items = [];
        projects.forEach(p => {
          if (p.name.toLowerCase().includes(q) || (p.client && p.client.toLowerCase().includes(q))) {
            items.push({ type: 'project', project: p, label: p.name, sub: p.client || '' });
          }
          (p.tasks || []).forEach(t => {
            if (t.name.toLowerCase().includes(q) || (t.assignee && t.assignee.toLowerCase().includes(q)) ||
                (t.tags && t.tags.some(tag => tag.includes(q)))) {
              items.push({ type: 'task', project: p, task: t, label: t.name, sub: `${p.name} ¬∑ ${t.assignee || 'sem respons√°vel'}` });
            }
          });
        });
        return items.slice(0, 10);
      }, [query, projects]);

      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-start justify-center pt-[15vh] z-[200] animate-fade-in" onClick={onClose}>
          <div className="bg-slate-800 border border-slate-600 rounded-2xl w-full max-w-lg mx-4 shadow-2xl animate-scale-in overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-3 px-4 py-3 border-b border-white/10">
              <Search className="w-5 h-5 text-slate-400" />
              <input
                ref={inputRef}
                type="text"
                value={query}
                onChange={e => setQuery(e.target.value)}
                onKeyDown={e => { if (e.key === 'Escape') onClose(); }}
                placeholder="Buscar projetos, tarefas, tags..."
                className="flex-1 bg-transparent text-white placeholder-slate-500 focus:outline-none text-sm"
              />
              <kbd className="text-xs text-slate-500 bg-white/5 px-1.5 py-0.5 rounded">ESC</kbd>
            </div>
            {results.length > 0 && (
              <div className="max-h-80 overflow-y-auto divide-y divide-white/5">
                {results.map((r, i) => (
                  <button key={i} onClick={() => { onSelect(r.project.id, r.task); onClose(); }}
                    className="w-full text-left px-4 py-3 hover:bg-white/5 transition flex items-center gap-3">
                    <span className={`text-xs px-1.5 py-0.5 rounded ${r.type === 'project' ? 'bg-cyan-500/20 text-cyan-400' : 'bg-purple-500/20 text-purple-400'}`}>
                      {r.type === 'project' ? 'Projeto' : 'Tarefa'}
                    </span>
                    <div className="flex-1 min-w-0">
                      <div className="text-sm text-white truncate">{r.label}</div>
                      <div className="text-xs text-slate-500 truncate">{r.sub}</div>
                    </div>
                  </button>
                ))}
              </div>
            )}
            {query && results.length === 0 && (
              <div className="px-4 py-8 text-center text-slate-500 text-sm">Nenhum resultado para "{query}"</div>
            )}
            {!query && (
              <div className="px-4 py-6 text-center text-slate-500 text-xs">Digite para buscar em todos os projetos e tarefas</div>
            )}
          </div>
        </div>
      );
    }

    function ProjectSidebar({ projects, selectedProject, onSelectProject, onDeleteProject, showNewProject, onToggleNewProject, onAddProject, onEditProject, projectFilter, setProjectFilter, showConfirm }) {
      const filtered = projects.filter(p => {
        if (!projectFilter) return true;
        const q = projectFilter.toLowerCase();
        return p.name.toLowerCase().includes(q) || (p.client && p.client.toLowerCase().includes(q));
      });

      return (
        <div className="glass rounded-2xl p-4 sm:p-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-bold">Projetos</h2>
            <button
              onClick={() => onToggleNewProject(true)}
              className="w-8 h-8 rounded-lg bg-cyan-500 hover:bg-cyan-600 flex items-center justify-center transition"
            >
              <Plus className="w-4 h-4" />
            </button>
          </div>

          {/* Project filter */}
          {projects.length > 1 && (
            <div className="relative mb-3">
              <Search className="w-3 h-3 absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-500" />
              <input type="text" value={projectFilter} onChange={(e) => setProjectFilter(e.target.value)}
                placeholder="Filtrar projeto ou cliente..."
                className="w-full pl-8 pr-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500/50 placeholder-slate-500" />
            </div>
          )}

          <div className="space-y-2">
            {filtered.map(project => {
              const taskCount = project.tasks.length;
              const avgProgress = taskCount > 0
                ? Math.round(project.tasks.reduce((a, t) => a + t.progress, 0) / taskCount)
                : 0;
              const overdueCount = project.tasks.filter(t => isOverdue(t)).length;

              return (
                <div
                  key={project.id}
                  className={`project-card p-4 rounded-xl cursor-pointer group ${
                    selectedProject === project.id
                      ? 'bg-white/10 border-2'
                      : 'bg-white/5 border-2 border-transparent hover:border-white/20'
                  }`}
                  style={{ borderColor: selectedProject === project.id ? project.color : undefined }}
                  onClick={() => onSelectProject(project.id)}
                >
                  <div className="flex items-start justify-between gap-2">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ background: project.color }} />
                        <h3 className="font-semibold text-sm truncate">{project.name}</h3>
                      </div>
                      {project.client && (
                        <div className="text-xs text-slate-500 truncate mb-0.5">{project.client}</div>
                      )}
                      <div className="flex items-center gap-2 text-xs text-slate-400 font-mono">
                        <span>{taskCount} tarefas</span>
                        {overdueCount > 0 && (
                          <span className="text-red-400">{overdueCount} atrasada{overdueCount > 1 ? 's' : ''}</span>
                        )}
                      </div>
                      {taskCount > 0 && (
                        <div className="mt-2 h-1.5 bg-white/10 rounded-full overflow-hidden">
                          <div className="h-full rounded-full transition-all duration-500" style={{ width: `${avgProgress}%`, background: project.color }} />
                        </div>
                      )}
                    </div>
                    <div className="flex flex-col gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition">
                      <button onClick={(e) => { e.stopPropagation(); onEditProject(project); }}
                        className="text-slate-400 hover:text-white transition">
                        <Edit2 className="w-3 h-3" />
                      </button>
                      {projects.length > 1 && (
                        <button onClick={(e) => { e.stopPropagation(); showConfirm('Deletar projeto e todas as suas tarefas?', () => onDeleteProject(project.id)); }}
                          className="text-slate-400 hover:text-red-400 transition">
                          <Trash2 className="w-3 h-3" />
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
            {filtered.length === 0 && projectFilter && (
              <p className="text-xs text-slate-500 text-center py-2">Nenhum projeto encontrado</p>
            )}
          </div>

          {showNewProject && (
            <NewProjectForm
              onSave={onAddProject}
              onCancel={() => onToggleNewProject(false)}
            />
          )}
        </div>
      );
    }

    // Color Picker component with presets + spectrum + HEX
    function ColorPicker({ value, onChange }) {
      const presets = ['#FF6B35', '#F7931E', '#00C9A7', '#845EC2', '#FF6F91', '#C34A36', '#00D2FC', '#3B82F6', '#10B981', '#F59E0B', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
      return (
        <div className="space-y-2">
          <div className="flex flex-wrap gap-2">
            {presets.map(c => (
              <button key={c} type="button" onClick={() => onChange(c)}
                className={`w-6 h-6 rounded-full transition ${value === c ? 'ring-2 ring-white scale-110' : 'hover:scale-110'}`}
                style={{ background: c }} />
            ))}
          </div>
          <div className="flex gap-2 items-center">
            <input type="color" value={value} onChange={(e) => onChange(e.target.value)}
              className="w-8 h-8 rounded cursor-pointer border-0 bg-transparent" title="Escolher cor personalizada" />
            <input type="text" value={value} onChange={(e) => { const v = e.target.value; if (/^#[0-9a-fA-F]{0,6}$/.test(v)) onChange(v); }}
              placeholder="#FF6B35" maxLength={7}
              className="px-2 py-1 bg-white/10 border border-white/20 rounded text-xs font-mono w-24 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
            <div className="w-5 h-5 rounded-full border border-white/20" style={{ background: value }} />
          </div>
        </div>
      );
    }

    // New Project Form Component
    function NewProjectForm({ onSave, onCancel }) {
      const [form, setForm] = useState({ name: '', client: '', description: '', color: '#FF6B35', deadline: '' });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (form.name.trim()) {
          onSave(form);
        }
      };

      return (
        <form onSubmit={handleSubmit} className="mt-4 p-4 bg-white/5 rounded-xl animate-scale-in space-y-3">
          <input type="text" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })}
            placeholder="Nome do projeto" className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500" autoFocus required />
          <input type="text" value={form.client} onChange={(e) => setForm({ ...form, client: e.target.value })}
            placeholder="Nome do cliente" className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500" />
          <input type="text" value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })}
            placeholder="Descri√ß√£o breve" className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500" />
          <input type="date" value={form.deadline} onChange={(e) => setForm({ ...form, deadline: e.target.value })}
            className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500" title="Prazo do projeto" />
          <ColorPicker value={form.color} onChange={(c) => setForm({ ...form, color: c })} />
          <div className="flex gap-2">
            <button type="submit" className="flex-1 px-3 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg text-sm font-medium transition">Criar</button>
            <button type="button" onClick={onCancel} className="px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm font-medium transition">Cancelar</button>
          </div>
        </form>
      );
    }

    // Task Form Component
    function TaskForm({ initialData, onSave, onCancel, existingTasks, team, isEditing }) {
      const [formData, setFormData] = useState(initialData || {
        name: '',
        description: '',
        start: new Date().toISOString().split('T')[0],
        end: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        assignee: '',
        status: 'pending',
        progress: 0,
        priority: 'medium',
        dependencies: []
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (formData.name.trim()) {
          // Auto-set progress when marking complete
          const data = { ...formData };
          if (data.status === 'completed' && data.progress < 100) {
            data.progress = 100;
          }
          onSave(data);
        }
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">Nome da Tarefa</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
              placeholder="Ex: Design do Key Visual"
              autoFocus
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">Descri√ß√£o</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none"
              placeholder="Descreva os detalhes e objetivos desta tarefa..."
              rows={3}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-2">Data In√≠cio</label>
              <input
                type="date"
                value={formData.start}
                onChange={(e) => setFormData({ ...formData, start: e.target.value })}
                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Data Fim</label>
              <input
                type="date"
                value={formData.end}
                onChange={(e) => setFormData({ ...formData, end: e.target.value })}
                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                required
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">Respons√°vel</label>
            {team && team.length > 0 ? (
              <select
                value={formData.assignee}
                onChange={(e) => setFormData({ ...formData, assignee: e.target.value })}
                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
              >
                <option value="" className="bg-slate-800">Selecione...</option>
                {team.map(m => (
                  <option key={m.id} value={m.name} className="bg-slate-800">{m.name} ({m.email})</option>
                ))}
              </select>
            ) : (
              <input
                type="text"
                value={formData.assignee}
                onChange={(e) => setFormData({ ...formData, assignee: e.target.value })}
                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                placeholder="Cadastre membros na Equipe primeiro"
              />
            )}
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">Prioridade</label>
            <div className="flex gap-2">
              {[
                { value: 'low', label: 'Baixa', color: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30', icon: 'üü¢' },
                { value: 'medium', label: 'M√©dia', color: 'bg-amber-500/20 text-amber-400 border-amber-500/30', icon: 'üü°' },
                { value: 'high', label: 'Alta', color: 'bg-red-500/20 text-red-400 border-red-500/30', icon: 'üî¥' },
              ].map(p => (
                <button
                  key={p.value}
                  type="button"
                  onClick={() => setFormData({ ...formData, priority: p.value })}
                  className={`flex-1 px-3 py-2 rounded-lg border text-sm font-medium transition ${
                    formData.priority === p.value ? p.color + ' border' : 'bg-white/5 border-white/10 text-slate-400 hover:bg-white/10'
                  }`}
                >
                  {p.icon} {p.label}
                </button>
              ))}
            </div>
          </div>

          {/* Tags */}
          <div>
            <label className="block text-sm font-medium mb-2">Tags</label>
            <div className="flex flex-wrap gap-1.5 mb-2">
              {(formData.tags || []).map((tag, i) => (
                <span key={i} className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-500/20 text-cyan-300">
                  {tag}
                  <button type="button" onClick={() => {
                    const tags = (formData.tags || []).filter((_, idx) => idx !== i);
                    setFormData({ ...formData, tags });
                  }} className="hover:text-red-400 transition">√ó</button>
                </span>
              ))}
            </div>
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="Digitar tag e Enter..."
                className="flex-1 px-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    const tag = e.target.value.trim().toLowerCase();
                    if (!(formData.tags || []).includes(tag)) {
                      setFormData({ ...formData, tags: [...(formData.tags || []), tag] });
                    }
                    e.target.value = '';
                  }
                }}
              />
            </div>
          </div>

          {/* Status and Progress - shown in edit mode */}
          {isEditing && (
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-2">Status</label>
                <select
                  value={formData.status}
                  onChange={(e) => {
                    const newStatus = e.target.value;
                    setFormData({
                      ...formData,
                      status: newStatus,
                      progress: newStatus === 'completed' ? 100 : (newStatus === 'pending' ? 0 : formData.progress)
                    });
                  }}
                  className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                >
                  <option value="pending" className="bg-slate-800">Pendente</option>
                  <option value="in-progress" className="bg-slate-800">Em Progresso</option>
                  <option value="completed" className="bg-slate-800">Conclu√≠da</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Progresso: {formData.progress}%</label>
                <input
                  type="range"
                  min="0"
                  max="100"
                  step="5"
                  value={formData.progress}
                  onChange={(e) => {
                    const prog = parseInt(e.target.value);
                    setFormData({
                      ...formData,
                      progress: prog,
                      status: prog === 100 ? 'completed' : (prog > 0 ? 'in-progress' : 'pending')
                    });
                  }}
                  className="w-full mt-2 accent-cyan-500"
                />
              </div>
            </div>
          )}

          {existingTasks && existingTasks.length > 0 && (
            <div>
              <label className="block text-sm font-medium mb-2">Depend√™ncias</label>
              <div className="space-y-2 max-h-32 overflow-y-auto">
                {existingTasks.filter(t => !initialData || t.id !== initialData.id).map(task => (
                  <label key={task.id} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/5 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={formData.dependencies?.includes(task.id)}
                      onChange={(e) => {
                        const deps = formData.dependencies || [];
                        setFormData({
                          ...formData,
                          dependencies: e.target.checked
                            ? [...deps, task.id]
                            : deps.filter(id => id !== task.id)
                        });
                      }}
                      className="rounded accent-cyan-500"
                    />
                    <span className="text-slate-300">{task.name}</span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {/* Subtasks / Checklist */}
          <div>
            <label className="block text-sm font-medium mb-2">Checklist / Subtarefas</label>
            <div className="space-y-1.5 mb-2">
              {(formData.subtasks || []).map((sub, i) => (
                <div key={i} className="flex items-center gap-2 group">
                  <input
                    type="checkbox"
                    checked={sub.done}
                    onChange={() => {
                      const subs = [...(formData.subtasks || [])];
                      subs[i] = { ...subs[i], done: !subs[i].done };
                      setFormData({ ...formData, subtasks: subs });
                    }}
                    className="rounded accent-cyan-500 flex-shrink-0"
                  />
                  <span className={`text-sm flex-1 ${sub.done ? 'line-through text-slate-500' : 'text-slate-300'}`}>{sub.text}</span>
                  <button type="button" onClick={() => {
                    const subs = (formData.subtasks || []).filter((_, idx) => idx !== i);
                    setFormData({ ...formData, subtasks: subs });
                  }} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded transition text-red-400">
                    <X className="w-3 h-3" />
                  </button>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="Adicionar item..."
                className="flex-1 px-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    const subs = [...(formData.subtasks || []), { text: e.target.value.trim(), done: false }];
                    setFormData({ ...formData, subtasks: subs });
                    e.target.value = '';
                  }
                }}
              />
            </div>
            {(formData.subtasks || []).length > 0 && (
              <div className="text-xs text-slate-500 mt-1">
                {(formData.subtasks || []).filter(s => s.done).length}/{(formData.subtasks || []).length} conclu√≠dos
              </div>
            )}
          </div>

          {/* Notes / Comments */}
          {isEditing && (
            <div>
              <label className="block text-sm font-medium mb-2">Notas / Coment√°rios</label>
              <div className="space-y-2 max-h-40 overflow-y-auto mb-2">
                {(formData.notes || []).map((note, i) => (
                  <div key={i} className="flex gap-2 text-xs bg-white/5 rounded-lg p-2 group">
                    <div className="flex-1">
                      <span className="text-slate-300">{note.text}</span>
                      <div className="text-slate-500 mt-0.5">{new Date(note.date).toLocaleString('pt-BR')}</div>
                    </div>
                    <button type="button" onClick={() => {
                      const notes = (formData.notes || []).filter((_, idx) => idx !== i);
                      setFormData({ ...formData, notes });
                    }} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded transition text-red-400 self-start">
                      <X className="w-3 h-3" />
                    </button>
                  </div>
                ))}
              </div>
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="Adicionar nota..."
                  className="flex-1 px-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                      e.preventDefault();
                      const notes = [...(formData.notes || []), { text: e.target.value.trim(), date: new Date().toISOString() }];
                      setFormData({ ...formData, notes });
                      e.target.value = '';
                    }
                  }}
                />
              </div>
            </div>
          )}

          <div className="flex gap-3 pt-2">
            <button
              type="submit"
              className="flex-1 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg font-medium hover:shadow-lg transition"
            >
              {initialData ? 'Salvar' : 'Criar Tarefa'}
            </button>
            <button
              type="button"
              onClick={onCancel}
              className="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg font-medium transition"
            >
              Cancelar
            </button>
          </div>
        </form>
      );
    }

    // Gantt View Component
    function GanttView({ project, onUpdateTask, onDeleteTask, onEditTask, onDuplicateTask, showConfirm }) {
      const dateRange = getDateRange(project);

      if (!dateRange || project.tasks.length === 0) {
        return (
          <div className="glass rounded-2xl p-12 text-center">
            <div className="w-20 h-20 mx-auto mb-4 bg-cyan-500/10 rounded-2xl flex items-center justify-center">
              <Calendar className="w-10 h-10 text-cyan-400" />
            </div>
            <h3 className="text-xl font-semibold mb-2">Nenhuma tarefa ainda</h3>
            <p className="text-slate-400 text-sm">Use o bot√£o <strong>+ Nova Tarefa</strong> acima para criar sua primeira tarefa e visualizar o Gantt</p>
          </div>
        );
      }

      const { minDate, maxDate, totalDays } = dateRange;

      const weeks = [];
      const currentDate = new Date(minDate);
      while (currentDate <= maxDate) {
        weeks.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 7);
      }

      const getStatusColor = (status) => {
        switch (status) {
          case 'completed': return '#00C9A7';
          case 'in-progress': return '#00D2FC';
          case 'pending': return '#845EC2';
          default: return '#64748b';
        }
      };

      return (
        <div className="glass rounded-2xl overflow-hidden">
          <div className="overflow-x-auto">
            <div className="min-w-[800px]">
              <div className="border-b border-white/10 bg-white/5">
                <div className="flex">
                  <div className="w-72 p-4 border-r border-white/10 flex-shrink-0">
                    <span className="text-sm font-semibold text-slate-400">TAREFA</span>
                  </div>
                  <div className="flex-1 p-4">
                    <div className="flex justify-between text-xs font-mono text-slate-400">
                      {weeks.map((date, i) => (
                        <div key={i} className="text-center">
                          <div className="font-semibold">{date.toLocaleDateString('pt-BR', { month: 'short' })}</div>
                          <div>{date.getDate()}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              <div className="divide-y divide-white/5">
                {project.tasks.map((task, index) => {
                  const leftPos = getDatePosition(task.start, minDate, totalDays);
                  const width = (getDuration(task.start, task.end) / totalDays) * 100;
                  const taskOverdue = isOverdue(task);
                  const taskDueSoon = isDueSoon(task);

                  return (
                    <div
                      key={task.id}
                      className={`task-row flex animate-slide-in ${taskOverdue ? 'bg-red-500/5' : ''}`}
                      style={{ animationDelay: `${index * 0.05}s` }}
                    >
                      <div className="w-72 p-4 border-r border-white/10 flex items-center gap-3 flex-shrink-0">
                        <button
                          onClick={() => {
                            const next = task.status === 'pending' ? 'in-progress' : task.status === 'in-progress' ? 'completed' : 'pending';
                            const progress = next === 'completed' ? 100 : next === 'in-progress' ? Math.max(task.progress, 10) : 0;
                            onUpdateTask(task.id, { status: next, progress });
                          }}
                          className={`w-4 h-4 rounded-full flex-shrink-0 border-2 transition hover:scale-125 ${
                            task.status === 'completed' ? 'bg-emerald-500 border-emerald-400' :
                            task.status === 'in-progress' ? 'bg-blue-500 border-blue-400' :
                            'bg-transparent border-slate-500 hover:border-slate-300'
                          }`}
                          title={`Status: ${task.status === 'completed' ? 'Conclu√≠da' : task.status === 'in-progress' ? 'Em Progresso' : 'Pendente'} (clique para mudar)`}
                        />
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-1.5 mb-1">
                            <span className="font-medium text-sm truncate">{task.name}</span>
                            {taskOverdue && (
                              <span title="Atrasada!" className="flex-shrink-0">
                                <AlertTriangle className="w-3.5 h-3.5 text-red-400" />
                              </span>
                            )}
                            {taskDueSoon && !taskOverdue && (
                              <span title="Vence em breve!" className="flex-shrink-0">
                                <AlertTriangle className="w-3.5 h-3.5 text-amber-400" />
                              </span>
                            )}
                          </div>
                          {task.description && (
                            <div className="text-xs text-slate-400 line-clamp-1 mb-1" title={task.description}>
                              {task.description}
                            </div>
                          )}
                          <div className="flex items-center gap-2 text-xs text-slate-400">
                            {task.priority && <PriorityBadge priority={task.priority} />}
                            {task.assignee && <span className="font-mono">{task.assignee}</span>}
                            <span className="px-2 py-0.5 rounded-full bg-white/10 font-mono">
                              {task.progress}%
                            </span>
                          </div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                          <button
                            onClick={() => onEditTask(task)}
                            className="p-1 hover:bg-white/10 rounded transition" title="Editar"
                          >
                            <Edit2 className="w-3 h-3" />
                          </button>
                          <button
                            onClick={() => onDuplicateTask(task)}
                            className="p-1 hover:bg-cyan-500/20 rounded transition text-cyan-400" title="Duplicar"
                          >
                            <Copy className="w-3 h-3" />
                          </button>
                          <button
                            onClick={() => showConfirm('Deletar tarefa?', () => onDeleteTask(task.id))}
                            className="p-1 hover:bg-red-500/20 rounded transition text-red-400" title="Deletar"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                      </div>

                      <div className="flex-1 p-4 relative">
                        <div
                          className={`gantt-bar h-8 rounded-lg flex items-center px-3 cursor-pointer relative overflow-hidden ${taskOverdue ? 'overdue-pulse' : ''}`}
                          style={{
                            left: `${leftPos}%`,
                            width: `${Math.max(width, 2)}%`,
                            background: taskOverdue
                              ? 'linear-gradient(135deg, #ef4444, #dc2626)'
                              : `linear-gradient(135deg, ${getStatusColor(task.status)}, ${getStatusColor(task.status)}dd)`,
                            position: 'absolute',
                            top: '16px'
                          }}
                          onClick={() => onEditTask(task)}
                          title={`${task.name} | ${task.progress}% | ${new Date(task.start).toLocaleDateString('pt-BR')} - ${new Date(task.end).toLocaleDateString('pt-BR')}`}
                        >
                          <div
                            className="absolute inset-0 bg-white/20"
                            style={{ width: `${task.progress}%` }}
                          />

                          <span className="text-xs font-semibold relative z-10 truncate">
                            {getDuration(task.start, task.end)}d
                          </span>
                        </div>

                        {/* Dependency arrows */}
                        {task.dependencies && task.dependencies.map(depId => {
                          const depTask = project.tasks.find(t => t.id === depId);
                          if (!depTask) return null;
                          const depEndPos = getDatePosition(depTask.end, minDate, totalDays);
                          const taskStartPos = getDatePosition(task.start, minDate, totalDays);
                          if (depEndPos >= taskStartPos) return null;
                          return (
                            <div
                              key={depId}
                              className="absolute top-5 h-0.5 bg-slate-500/40"
                              style={{
                                left: `${depEndPos + 0.5}%`,
                                width: `${taskStartPos - depEndPos - 0.5}%`,
                              }}
                            >
                              <div className="absolute right-0 top-1/2 -translate-y-1/2 w-0 h-0 border-t-[3px] border-t-transparent border-b-[3px] border-b-transparent border-l-[5px] border-l-slate-500/60" />
                            </div>
                          );
                        })}

                        {(() => {
                          const today = new Date();
                          if (today >= minDate && today <= maxDate) {
                            const todayPos = getDatePosition(today.toISOString().split('T')[0], minDate, totalDays);
                            return (
                              <div
                                className="absolute top-0 bottom-0 w-0.5 bg-red-500 opacity-50"
                                style={{ left: `${todayPos}%` }}
                              >
                                <div className="absolute -top-2 -left-6 text-xs font-mono text-red-500">Hoje</div>
                              </div>
                            );
                          }
                          return null;
                        })()}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // List View Component
    function ListView({ project, onUpdateTask, onDeleteTask, onEditTask, onDuplicateTask, activeTimer, onStartTimer, onStopTimer, showConfirm }) {
      const [selectedTasks, setSelectedTasks] = useState([]);

      const toggleTask = (id) => setSelectedTasks(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      const toggleAll = () => setSelectedTasks(prev => prev.length === project.tasks.length ? [] : project.tasks.map(t => t.id));

      const bulkAction = (action) => {
        if (action === 'complete') selectedTasks.forEach(id => onUpdateTask(id, { status: 'completed', progress: 100 }));
        else if (action === 'pending') selectedTasks.forEach(id => onUpdateTask(id, { status: 'pending', progress: 0 }));
        else if (action === 'delete') showConfirm(`Deletar ${selectedTasks.length} tarefas?`, () => selectedTasks.forEach(id => onDeleteTask(id)));
        setSelectedTasks([]);
      };

      const getStatusLabel = (status) => {
        switch (status) {
          case 'completed': return 'Conclu√≠da';
          case 'in-progress': return 'Em Progresso';
          case 'pending': return 'Pendente';
          default: return status;
        }
      };

      const getStatusColor = (status) => {
        switch (status) {
          case 'completed': return 'bg-emerald-500/20 text-emerald-400';
          case 'in-progress': return 'bg-blue-500/20 text-blue-400';
          case 'pending': return 'bg-purple-500/20 text-purple-400';
          default: return 'bg-slate-500/20 text-slate-400';
        }
      };

      if (project.tasks.length === 0) {
        return (
          <div className="glass rounded-2xl p-12 text-center">
            <div className="w-20 h-20 mx-auto mb-4 bg-emerald-500/10 rounded-2xl flex items-center justify-center">
              <Plus className="w-10 h-10 text-emerald-400" />
            </div>
            <h3 className="text-xl font-semibold mb-2">Nenhuma tarefa ainda</h3>
            <p className="text-slate-400 text-sm">Use o bot√£o <strong>+ Nova Tarefa</strong> acima para adicionar tarefas a este projeto</p>
          </div>
        );
      }

      return (
        <div className="glass rounded-2xl overflow-hidden">
          {selectedTasks.length > 0 && (
            <div className="bg-cyan-500/10 border-b border-cyan-500/20 px-4 py-2 flex items-center gap-3 animate-fade-in">
              <span className="text-sm text-cyan-300 font-medium">{selectedTasks.length} selecionada{selectedTasks.length > 1 ? 's' : ''}</span>
              <button onClick={() => bulkAction('complete')} className="px-2.5 py-1 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg text-xs font-medium transition">Concluir</button>
              <button onClick={() => bulkAction('pending')} className="px-2.5 py-1 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg text-xs font-medium transition">Pendente</button>
              <button onClick={() => bulkAction('delete')} className="px-2.5 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-xs font-medium transition">Deletar</button>
              <button onClick={() => setSelectedTasks([])} className="ml-auto text-xs text-slate-400 hover:text-white transition">Cancelar</button>
            </div>
          )}
          <div className="overflow-x-auto">
            <table className="w-full min-w-[700px]">
              <thead className="bg-white/5 border-b border-white/10">
                <tr>
                  <th className="p-4 w-10"><input type="checkbox" onChange={toggleAll} checked={selectedTasks.length === project.tasks.length && project.tasks.length > 0} className="rounded accent-cyan-500" /></th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">TAREFA</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400 hidden lg:table-cell">DESCRI√á√ÉO</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">STATUS</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">RESPONS√ÅVEL</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">PRIORIDADE</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">PER√çODO</th>
                  <th className="text-left p-4 text-sm font-semibold text-slate-400">PROGRESSO</th>
                  <th className="text-right p-4 text-sm font-semibold text-slate-400">A√á√ïES</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-white/5">
                {project.tasks.map((task, index) => {
                  const taskOverdue = isOverdue(task);
                  const taskDueSoon = isDueSoon(task);

                  return (
                    <tr
                      key={task.id}
                      className={`task-row animate-slide-in ${taskOverdue ? 'bg-red-500/5' : ''} ${selectedTasks.includes(task.id) ? 'bg-cyan-500/5' : ''}`}
                      style={{ animationDelay: `${index * 0.05}s` }}
                    >
                      <td className="p-4 w-10">
                        <input type="checkbox" checked={selectedTasks.includes(task.id)} onChange={() => toggleTask(task.id)} className="rounded accent-cyan-500" />
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-2">
                          <span className="font-medium">{task.name}</span>
                          {taskOverdue && <AlertTriangle className="w-3.5 h-3.5 text-red-400 flex-shrink-0" title="Atrasada!" />}
                          {taskDueSoon && !taskOverdue && <AlertTriangle className="w-3.5 h-3.5 text-amber-400 flex-shrink-0" title="Vence em breve!" />}
                        </div>
                      </td>
                      <td className="p-4 max-w-xs hidden lg:table-cell">
                        <div className="text-sm text-slate-300 line-clamp-2" title={task.description}>
                          {task.description || <span className="text-slate-500 italic">Sem descri√ß√£o</span>}
                        </div>
                      </td>
                      <td className="p-4">
                        <span className={`px-3 py-1 rounded-full text-xs font-semibold ${taskOverdue ? 'bg-red-500/20 text-red-400' : getStatusColor(task.status)}`}>
                          {taskOverdue ? 'Atrasada' : getStatusLabel(task.status)}
                        </span>
                      </td>
                      <td className="p-4">
                        <span className="text-sm font-mono text-slate-300">{task.assignee || '-'}</span>
                      </td>
                      <td className="p-4">
                        <PriorityBadge priority={task.priority || 'medium'} />
                      </td>
                      <td className="p-4">
                        <div className="text-sm font-mono text-slate-300 whitespace-nowrap">
                          {new Date(task.start).toLocaleDateString('pt-BR')} ‚Üí {new Date(task.end).toLocaleDateString('pt-BR')}
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="flex-1 h-2 bg-white/10 rounded-full overflow-hidden min-w-[60px]">
                            <div
                              className={`h-full rounded-full transition-all ${taskOverdue ? 'bg-red-500' : 'bg-gradient-to-r from-cyan-500 to-blue-500'}`}
                              style={{ width: `${task.progress}%` }}
                            />
                          </div>
                          <span className="text-sm font-mono text-slate-400 w-12 text-right">
                            {task.progress}%
                          </span>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex justify-end gap-1">
                          {activeTimer && activeTimer.taskId === task.id ? (
                            <button
                              onClick={onStopTimer}
                              className="p-2 hover:bg-red-500/20 rounded-lg transition text-red-400"
                              title="Parar timer"
                            >
                              <Square className="w-4 h-4" />
                            </button>
                          ) : (
                            <button
                              onClick={() => { if (activeTimer) onStopTimer(); onStartTimer(task.id, project.id); }}
                              className="p-2 hover:bg-emerald-500/20 rounded-lg transition text-emerald-400"
                              title="Iniciar timer"
                            >
                              <Play className="w-4 h-4" />
                            </button>
                          )}
                          <button
                            onClick={() => onEditTask(task)}
                            className="p-2 hover:bg-white/10 rounded-lg transition"
                            title="Editar tarefa"
                          >
                            <Edit2 className="w-4 h-4" />
                          </button>
                          <button
                            onClick={() => {
                              const newStatus = task.status === 'pending' ? 'in-progress' :
                                               task.status === 'in-progress' ? 'completed' : 'pending';
                              const newProgress = newStatus === 'completed' ? 100 : (newStatus === 'pending' ? 0 : task.progress);
                              onUpdateTask(task.id, { status: newStatus, progress: newProgress });
                            }}
                            className="p-2 hover:bg-white/10 rounded-lg transition"
                            title="Avan√ßar status"
                          >
                            <ChevronRight className="w-4 h-4" />
                          </button>
                          <button
                            onClick={() => onDuplicateTask(task)}
                            className="p-2 hover:bg-cyan-500/20 text-cyan-400 rounded-lg transition"
                            title="Duplicar tarefa"
                          >
                            <Copy className="w-4 h-4" />
                          </button>
                          <button
                            onClick={() => showConfirm('Deletar tarefa?', () => onDeleteTask(task.id))}
                            className="p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition"
                            title="Deletar tarefa"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // Rich Text Editor using contentEditable
    function RichTextEditor({ value, onChange, placeholder }) {
      const editorRef = useRef(null);
      const isInitialized = useRef(false);

      useEffect(() => {
        if (editorRef.current && !isInitialized.current) {
          editorRef.current.innerHTML = value || '';
          isInitialized.current = true;
        }
      }, []);

      const execCmd = (cmd, val) => {
        document.execCommand(cmd, false, val || null);
        editorRef.current?.focus();
        if (onChange) onChange(editorRef.current.innerHTML);
      };

      const handleInput = () => {
        if (onChange) onChange(editorRef.current.innerHTML);
      };

      const btnClass = "p-1.5 hover:bg-white/20 rounded transition text-slate-300 hover:text-white text-xs";
      const activeBtnClass = (cmd) => document.queryCommandState(cmd) ? 'bg-white/20 text-white' : '';

      return (
        <div className="border border-white/20 rounded-lg overflow-hidden">
          <div className="flex flex-wrap gap-0.5 p-1.5 bg-white/5 border-b border-white/10">
            <button type="button" onClick={() => execCmd('bold')} className={`${btnClass} font-bold`} title="Negrito">B</button>
            <button type="button" onClick={() => execCmd('italic')} className={`${btnClass} italic`} title="It√°lico">I</button>
            <button type="button" onClick={() => execCmd('underline')} className={`${btnClass} underline`} title="Sublinhado">U</button>
            <span className="w-px bg-white/10 mx-1" />
            <button type="button" onClick={() => execCmd('formatBlock', 'H3')} className={btnClass} title="T√≠tulo">H</button>
            <button type="button" onClick={() => execCmd('insertUnorderedList')} className={btnClass} title="Lista">‚Ä¢ Lista</button>
            <button type="button" onClick={() => execCmd('insertOrderedList')} className={btnClass} title="Lista numerada">1. Lista</button>
            <span className="w-px bg-white/10 mx-1" />
            <button type="button" onClick={() => execCmd('justifyLeft')} className={btnClass} title="Alinhar esquerda">‚Üê</button>
            <button type="button" onClick={() => execCmd('justifyCenter')} className={btnClass} title="Centralizar">‚Üî</button>
            <button type="button" onClick={() => execCmd('removeFormat')} className={`${btnClass} text-slate-500`} title="Limpar formata√ß√£o">‚úï</button>
          </div>
          <div
            ref={editorRef}
            contentEditable
            onInput={handleInput}
            className="min-h-[120px] max-h-[300px] overflow-y-auto p-3 text-sm focus:outline-none bg-white/5"
            style={{ lineHeight: '1.6' }}
            data-placeholder={placeholder}
          />
        </div>
      );
    }

    // Briefing Display Component (collapsible)
    function BriefingDisplay({ briefing }) {
      const [open, setOpen] = useState(false);
      if (!briefing) return null;
      return (
        <div className="glass rounded-xl mb-4 overflow-hidden">
          <button onClick={() => setOpen(!open)}
            className="w-full flex items-center justify-between p-3 text-sm font-medium text-slate-300 hover:bg-white/5 transition">
            <span className="flex items-center gap-2">
              <Calendar className="w-3.5 h-3.5 text-cyan-400" />
              Briefing do Projeto
            </span>
            <ChevronRight className={`w-4 h-4 transition-transform ${open ? 'rotate-90' : ''}`} />
          </button>
          {open && (
            <div className="px-4 pb-4 text-sm text-slate-300 prose-sm animate-fade-in"
              style={{ lineHeight: '1.6' }}
              dangerouslySetInnerHTML={{ __html: briefing }}
            />
          )}
        </div>
      );
    }

    // Edit Project Modal
    function EditProjectModal({ project, onSave, onClose }) {
      const [form, setForm] = useState({
        name: project.name || '',
        client: project.client || '',
        description: project.description || '',
        briefing: project.briefing || '',
        color: project.color || '#FF6B35',
        deadline: project.deadline || '',
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (form.name.trim()) onSave(form);
      };

      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
          <div className="glass rounded-2xl p-6 max-w-xl w-full mx-4 animate-scale-in max-h-[85vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold">Editar Projeto</h3>
              <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-lg transition">
                <X className="w-5 h-5" />
              </button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Nome do Projeto</label>
                <input type="text" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })}
                  className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Cliente</label>
                <input type="text" value={form.client} onChange={(e) => setForm({ ...form, client: e.target.value })}
                  placeholder="Nome do cliente" className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Descri√ß√£o</label>
                <input type="text" value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })}
                  placeholder="Descri√ß√£o breve do projeto" className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Prazo</label>
                <input type="date" value={form.deadline} onChange={(e) => setForm({ ...form, deadline: e.target.value })}
                  className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Cor</label>
                <ColorPicker value={form.color} onChange={(c) => setForm({ ...form, color: c })} />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Briefing</label>
                <RichTextEditor value={form.briefing} onChange={(html) => setForm({ ...form, briefing: html })} placeholder="Escreva o briefing do projeto aqui..." />
              </div>
              <div className="flex gap-3 pt-2">
                <button type="submit" className="flex-1 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg font-medium hover:shadow-lg transition">Salvar</button>
                <button type="button" onClick={onClose} className="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg font-medium transition">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Timesheet Panel Component
    function TimesheetPanel({ timeLogs, projects, team, onAddLog, onDeleteLog, onClose, showConfirm }) {
      const [tab, setTab] = useState('logs'); // logs, byProject, byMember
      const [manualForm, setManualForm] = useState({ projectId: '', taskId: '', assignee: '', hours: '', minutes: '', date: new Date().toISOString().split('T')[0] });
      const [showManual, setShowManual] = useState(false);

      // Summary by project
      const byProject = useMemo(() => {
        const map = {};
        timeLogs.forEach(log => {
          if (!map[log.projectName]) map[log.projectName] = { name: log.projectName, seconds: 0, logs: 0 };
          map[log.projectName].seconds += log.seconds;
          map[log.projectName].logs += 1;
        });
        return Object.values(map).sort((a, b) => b.seconds - a.seconds);
      }, [timeLogs]);

      // Summary by member
      const byMember = useMemo(() => {
        const map = {};
        timeLogs.forEach(log => {
          const name = log.assignee || 'Sem respons√°vel';
          if (!map[name]) map[name] = { name, seconds: 0, logs: 0, projects: new Set() };
          map[name].seconds += log.seconds;
          map[name].logs += 1;
          map[name].projects.add(log.projectName);
        });
        return Object.values(map).map(m => ({ ...m, projectCount: m.projects.size })).sort((a, b) => b.seconds - a.seconds);
      }, [timeLogs]);

      const totalSeconds = timeLogs.reduce((a, l) => a + l.seconds, 0);

      const selectedProjectTasks = useMemo(() => {
        if (!manualForm.projectId) return [];
        const p = projects.find(pr => pr.id === parseInt(manualForm.projectId));
        return p ? p.tasks : [];
      }, [manualForm.projectId, projects]);

      const handleManualSubmit = (e) => {
        e.preventDefault();
        const h = parseInt(manualForm.hours) || 0;
        const m = parseInt(manualForm.minutes) || 0;
        const seconds = h * 3600 + m * 60;
        if (seconds <= 0) return;
        const project = projects.find(p => p.id === parseInt(manualForm.projectId));
        const task = project?.tasks?.find(t => t.id === parseInt(manualForm.taskId));
        onAddLog({
          taskId: task?.id || 0,
          taskName: task?.name || 'Manual',
          projectId: project?.id || 0,
          projectName: project?.name || 'Projeto',
          assignee: manualForm.assignee,
          date: manualForm.date,
          seconds,
        });
        setShowManual(false);
        setManualForm({ projectId: '', taskId: '', assignee: '', hours: '', minutes: '', date: new Date().toISOString().split('T')[0] });
      };

      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
          <div className="glass rounded-2xl p-6 max-w-2xl w-full mx-4 animate-scale-in max-h-[85vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <Clock className="w-5 h-5 text-cyan-400" />
                <h3 className="text-xl font-bold">Timesheet</h3>
                <span className="text-xs font-mono text-slate-400 bg-white/5 px-2 py-0.5 rounded">Total: {formatHours(totalSeconds)}</span>
              </div>
              <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-lg transition">
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Tabs */}
            <div className="flex gap-1 bg-white/5 rounded-lg p-1 mb-4">
              {[
                { key: 'logs', label: 'Registros' },
                { key: 'byProject', label: 'Por Projeto' },
                { key: 'byMember', label: 'Por Colaborador' },
              ].map(t => (
                <button key={t.key} onClick={() => setTab(t.key)}
                  className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition ${tab === t.key ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}
                >{t.label}</button>
              ))}
            </div>

            {/* Add manual button */}
            <button onClick={() => setShowManual(!showManual)} className="mb-4 px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs font-medium transition flex items-center gap-1.5">
              <Plus className="w-3 h-3" /> Registro Manual
            </button>

            {/* Manual form */}
            {showManual && (
              <form onSubmit={handleManualSubmit} className="mb-4 p-4 bg-white/5 rounded-xl space-y-3 animate-scale-in">
                <div className="grid grid-cols-2 gap-3">
                  <select value={manualForm.projectId} onChange={(e) => setManualForm({ ...manualForm, projectId: e.target.value, taskId: '' })}
                    className="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    <option value="" className="bg-slate-800">Projeto...</option>
                    {projects.map(p => <option key={p.id} value={p.id} className="bg-slate-800">{p.name}</option>)}
                  </select>
                  <select value={manualForm.taskId} onChange={(e) => setManualForm({ ...manualForm, taskId: e.target.value })}
                    className="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <option value="" className="bg-slate-800">Tarefa...</option>
                    {selectedProjectTasks.map(t => <option key={t.id} value={t.id} className="bg-slate-800">{t.name}</option>)}
                  </select>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <select value={manualForm.assignee} onChange={(e) => setManualForm({ ...manualForm, assignee: e.target.value })}
                    className="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <option value="" className="bg-slate-800">Colaborador...</option>
                    {team.map(m => <option key={m.id} value={m.name} className="bg-slate-800">{m.name}</option>)}
                  </select>
                  <div className="flex gap-2">
                    <input type="number" min="0" max="99" placeholder="Horas" value={manualForm.hours} onChange={(e) => setManualForm({ ...manualForm, hours: e.target.value })}
                      className="w-full px-2 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    <input type="number" min="0" max="59" placeholder="Min" value={manualForm.minutes} onChange={(e) => setManualForm({ ...manualForm, minutes: e.target.value })}
                      className="w-full px-2 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                  </div>
                  <input type="date" value={manualForm.date} onChange={(e) => setManualForm({ ...manualForm, date: e.target.value })}
                    className="px-2 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                </div>
                <button type="submit" className="w-full px-3 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg text-xs font-medium transition">Registrar</button>
              </form>
            )}

            {/* Logs tab */}
            {tab === 'logs' && (
              timeLogs.length === 0 ? (
                <div className="text-center py-8"><div className="w-16 h-16 mx-auto mb-3 bg-cyan-500/10 rounded-2xl flex items-center justify-center"><Clock className="w-8 h-8 text-cyan-400" /></div><p className="text-slate-400 text-sm">Nenhum registro de horas ainda.</p><p className="text-slate-500 text-xs mt-1">Use o botao &#9654; nas tarefas para iniciar o timer</p></div>
              ) : (
                <div className="space-y-2">
                  {[...timeLogs].reverse().map(log => (
                    <div key={log.id} className="flex items-center gap-3 p-3 bg-white/5 rounded-xl group hover:bg-white/10 transition">
                      <Clock className="w-4 h-4 text-cyan-400 flex-shrink-0" />
                      <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium truncate">{log.taskName}</div>
                        <div className="text-xs text-slate-400">
                          {log.projectName} {log.assignee && `‚Ä¢ ${log.assignee}`} ‚Ä¢ {new Date(log.date).toLocaleDateString('pt-BR')}
                        </div>
                      </div>
                      <span className="font-mono text-sm text-cyan-400 font-bold flex-shrink-0">{formatHours(log.seconds)}</span>
                      <button onClick={() => showConfirm('Remover registro de tempo?', () => onDeleteLog(log.id))}
                        className="p-1 text-slate-400 hover:text-red-400 transition opacity-0 group-hover:opacity-100 flex-shrink-0">
                        <Trash2 className="w-3 h-3" />
                      </button>
                    </div>
                  ))}
                </div>
              )
            )}

            {/* By Project tab */}
            {tab === 'byProject' && (
              byProject.length === 0 ? (
                <p className="text-center text-slate-400 text-sm py-8">Sem dados ainda.</p>
              ) : (
                <div className="space-y-3">
                  {byProject.map(p => {
                    const pct = totalSeconds > 0 ? Math.round((p.seconds / totalSeconds) * 100) : 0;
                    return (
                      <div key={p.name} className="p-4 bg-white/5 rounded-xl">
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-medium text-sm">{p.name}</span>
                          <span className="font-mono text-sm text-cyan-400 font-bold">{formatHours(p.seconds)}</span>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                            <div className="h-full rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all" style={{ width: `${pct}%` }} />
                          </div>
                          <span className="text-xs text-slate-400 font-mono w-10 text-right">{pct}%</span>
                        </div>
                        <div className="text-xs text-slate-400 mt-1">{p.logs} registro{p.logs !== 1 ? 's' : ''}</div>
                      </div>
                    );
                  })}
                </div>
              )
            )}

            {/* By Member tab */}
            {tab === 'byMember' && (
              byMember.length === 0 ? (
                <p className="text-center text-slate-400 text-sm py-8">Sem dados ainda.</p>
              ) : (
                <div className="space-y-3">
                  {byMember.map(m => {
                    const member = team.find(t => t.name === m.name);
                    const pct = totalSeconds > 0 ? Math.round((m.seconds / totalSeconds) * 100) : 0;
                    return (
                      <div key={m.name} className="p-4 bg-white/5 rounded-xl">
                        <div className="flex items-center gap-3 mb-2">
                          <div className="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                            style={{ background: member?.color || '#64748b' }}>
                            {m.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2)}
                          </div>
                          <div className="flex-1">
                            <div className="font-medium text-sm">{m.name}</div>
                            <div className="text-xs text-slate-400">{m.projectCount} projeto{m.projectCount !== 1 ? 's' : ''} ‚Ä¢ {m.logs} registro{m.logs !== 1 ? 's' : ''}</div>
                          </div>
                          <span className="font-mono text-sm text-cyan-400 font-bold">{formatHours(m.seconds)}</span>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                            <div className="h-full rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all" style={{ width: `${pct}%` }} />
                          </div>
                          <span className="text-xs text-slate-400 font-mono w-10 text-right">{pct}%</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )
            )}
          </div>
        </div>
      );
    }

    // Team Manager Component
    function TeamManager({ team, setTeam, emailConfig, setEmailConfig, onClose, showToast, showConfirm }) {
      const [newName, setNewName] = useState('');
      const [newEmail, setNewEmail] = useState('');
      const [newColor, setNewColor] = useState('#06b6d4');
      const avatarColors = ['#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#f97316', '#14b8a6', '#6366f1'];

      const addMember = (e) => {
        e.preventDefault();
        if (!newName.trim() || !newEmail.trim()) return;
        const member = { id: Date.now(), name: newName.trim(), email: newEmail.trim(), color: newColor };
        setTeam([...team, member]);
        setNewName(''); setNewEmail(''); setNewColor('#06b6d4');
        showToast(`${member.name} adicionado √† equipe`, 'success');
      };

      const removeMember = (id) => {
        setTeam(team.filter(m => m.id !== id));
        showToast('Membro removido', 'info');
      };

      const getInitials = (name) => name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);

      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
          <div className="glass rounded-2xl p-6 max-w-lg w-full mx-4 animate-scale-in max-h-[80vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Users className="w-5 h-5 text-cyan-400" />
                <h3 className="text-xl font-bold">Equipe</h3>
              </div>
              <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-lg transition">
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Add member form */}
            <form onSubmit={addMember} className="mb-6 p-4 bg-white/5 rounded-xl space-y-3">
              <h4 className="text-sm font-semibold text-slate-300">Novo Membro</h4>
              <input
                type="text"
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                placeholder="Nome completo"
                className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"
                required
              />
              <input
                type="email"
                value={newEmail}
                onChange={(e) => setNewEmail(e.target.value)}
                placeholder="Email"
                className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"
                required
              />
              <div>
                <label className="block text-xs text-slate-400 mb-1">Cor do avatar</label>
                <div className="flex gap-2">
                  {avatarColors.map(c => (
                    <button key={c} type="button" onClick={() => setNewColor(c)}
                      className={`w-6 h-6 rounded-full transition ${newColor === c ? 'ring-2 ring-white scale-110' : 'hover:scale-110'}`}
                      style={{ background: c }} />
                  ))}
                </div>
              </div>
              <button type="submit" className="w-full px-3 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg text-sm font-medium transition">
                Adicionar Membro
              </button>
            </form>

            {/* Team list */}
            {team.length === 0 ? (
              <div className="text-center py-6"><div className="w-16 h-16 mx-auto mb-3 bg-emerald-500/10 rounded-2xl flex items-center justify-center"><Users className="w-8 h-8 text-emerald-400" /></div><p className="text-slate-400 text-sm">Nenhum membro cadastrado</p><p className="text-slate-500 text-xs mt-1">Adicione membros usando o formulario acima</p></div>
            ) : (
              <div className="space-y-2">
                {team.map(m => (
                  <div key={m.id} className="flex items-center gap-3 p-3 bg-white/5 rounded-xl group hover:bg-white/10 transition">
                    <div className="w-9 h-9 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0" style={{ background: m.color }}>
                      {getInitials(m.name)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="font-medium text-sm truncate">{m.name}</div>
                      <div className="text-xs text-slate-400 truncate">{m.email}</div>
                    </div>
                    <button
                      onClick={() => showConfirm(`Remover ${m.name} da equipe?`, () => removeMember(m.id))}
                      className="p-1 text-slate-400 hover:text-red-400 transition opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                ))}
              </div>
            )}

            {/* EmailJS Config */}
            <div className="mt-6 p-4 bg-white/5 rounded-xl space-y-3 border border-white/10">
              <h4 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                Notifica√ß√µes por Email (EmailJS)
                <span className={`px-1.5 py-0.5 rounded text-xs ${emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey ? 'bg-emerald-500/20 text-emerald-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                  {emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey ? 'Configurado' : 'Pendente'}
                </span>
              </h4>
              <p className="text-xs text-slate-400">
                Crie uma conta gratuita em <span className="text-cyan-400">emailjs.com</span> para enviar emails autom√°ticos quando tarefas forem atribu√≠das.
              </p>
              <input
                type="text"
                value={emailConfig.serviceId || ''}
                onChange={(e) => setEmailConfig({ ...emailConfig, serviceId: e.target.value })}
                placeholder="Service ID (ex: service_xxxxxxx)"
                className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500"
              />
              <input
                type="text"
                value={emailConfig.templateId || ''}
                onChange={(e) => setEmailConfig({ ...emailConfig, templateId: e.target.value })}
                placeholder="Template ID (ex: template_xxxxxxx)"
                className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500"
              />
              <input
                type="text"
                value={emailConfig.publicKey || ''}
                onChange={(e) => setEmailConfig({ ...emailConfig, publicKey: e.target.value })}
                placeholder="Public Key (ex: xXxXxXxXxXxXx)"
                className="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-cyan-500"
              />
              <p className="text-xs text-slate-500">
                No template use: {'{{to_name}}, {{to_email}}, {{task_name}}, {{task_description}}, {{task_start}}, {{task_end}}, {{project_name}}'}
              </p>
            </div>
          </div>
        </div>
      );
    }

    // Kanban View Component
    function KanbanView({ project, onUpdateTask, onDeleteTask, onEditTask, onDuplicateTask, activeTimer, onStartTimer, onStopTimer, showConfirm }) {
      const columns = [
        { status: 'pending', label: 'Pendente', color: 'purple', bg: 'bg-purple-500/10', border: 'border-purple-500/30', badge: 'bg-purple-500/20 text-purple-400' },
        { status: 'in-progress', label: 'Em Progresso', color: 'blue', bg: 'bg-blue-500/10', border: 'border-blue-500/30', badge: 'bg-blue-500/20 text-blue-400' },
        { status: 'completed', label: 'Conclu√≠da', color: 'emerald', bg: 'bg-emerald-500/10', border: 'border-emerald-500/30', badge: 'bg-emerald-500/20 text-emerald-400' },
      ];

      const handleDragStart = (e, taskId) => {
        e.dataTransfer.setData('text/plain', taskId.toString());
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('ring-2', 'ring-cyan-500/50');
      };

      const handleDragLeave = (e) => {
        e.currentTarget.classList.remove('ring-2', 'ring-cyan-500/50');
      };

      const handleDrop = (e, newStatus) => {
        e.preventDefault();
        e.currentTarget.classList.remove('ring-2', 'ring-cyan-500/50');
        const taskId = parseInt(e.dataTransfer.getData('text/plain'));
        const task = project.tasks.find(t => t.id === taskId);
        if (task && task.status !== newStatus) {
          const newProgress = newStatus === 'completed' ? 100 : (newStatus === 'pending' ? 0 : (task.progress > 0 ? task.progress : 10));
          onUpdateTask(taskId, { status: newStatus, progress: newProgress });
        }
      };

      if (project.tasks.length === 0) {
        return (
          <div className="glass rounded-2xl p-12 text-center">
            <div className="w-20 h-20 mx-auto mb-4 bg-blue-500/10 rounded-2xl flex items-center justify-center">
              <GripVertical className="w-10 h-10 text-blue-400" />
            </div>
            <h3 className="text-xl font-semibold mb-2">Nenhuma tarefa ainda</h3>
            <p className="text-slate-400 text-sm">Use o bot√£o <strong>+ Nova Tarefa</strong> acima para criar tarefas e visualizar o Kanban</p>
          </div>
        );
      }

      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {columns.map(col => {
            const tasks = project.tasks.filter(t => t.status === col.status);
            return (
              <div
                key={col.status}
                className={`glass rounded-2xl p-4 min-h-[300px] transition-all ${col.bg} border ${col.border}`}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={(e) => handleDrop(e, col.status)}
              >
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold text-sm">{col.label}</h3>
                  <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${col.badge}`}>{tasks.length}</span>
                </div>
                <div className="space-y-3">
                  {tasks.map(task => {
                    const taskOverdue = isOverdue(task);
                    return (
                      <div
                        key={task.id}
                        draggable
                        onDragStart={(e) => handleDragStart(e, task.id)}
                        className={`bg-slate-800/80 border border-white/10 rounded-xl p-3 cursor-grab active:cursor-grabbing hover:border-white/20 transition animate-scale-in ${taskOverdue ? 'border-red-500/40 bg-red-500/5' : ''}`}
                      >
                        <div className="flex items-start justify-between gap-2 mb-2">
                          <span className="font-medium text-sm">{task.name}</span>
                          <div className="flex gap-1 flex-shrink-0">
                            {activeTimer && activeTimer.taskId === task.id ? (
                              <button onClick={onStopTimer} className="p-1 hover:bg-red-500/20 rounded transition text-red-400" title="Parar timer">
                                <Square className="w-3 h-3" />
                              </button>
                            ) : (
                              <button onClick={() => { if (activeTimer) onStopTimer(); onStartTimer(task.id, project.id); }} className="p-1 hover:bg-emerald-500/20 rounded transition text-emerald-400" title="Iniciar timer">
                                <Play className="w-3 h-3" />
                              </button>
                            )}
                            <button onClick={() => onEditTask(task)} className="p-1 hover:bg-white/10 rounded transition" title="Editar">
                              <Edit2 className="w-3 h-3" />
                            </button>
                            <button onClick={() => onDuplicateTask(task)} className="p-1 hover:bg-cyan-500/20 rounded transition text-cyan-400" title="Duplicar">
                              <Copy className="w-3 h-3" />
                            </button>
                            <button onClick={() => showConfirm('Deletar tarefa?', () => onDeleteTask(task.id))} className="p-1 hover:bg-red-500/20 rounded transition text-red-400" title="Deletar">
                              <Trash2 className="w-3 h-3" />
                            </button>
                          </div>
                        </div>
                        {task.tags && task.tags.length > 0 && (
                          <div className="flex flex-wrap gap-1 mb-2">
                            {task.tags.map((tag, i) => (
                              <span key={i} className="px-1.5 py-0.5 rounded text-[10px] font-medium bg-cyan-500/15 text-cyan-400">{tag}</span>
                            ))}
                          </div>
                        )}
                        {task.description && (
                          <p className="text-xs text-slate-400 line-clamp-2 mb-2">{task.description}</p>
                        )}
                        {task.subtasks && task.subtasks.length > 0 && (
                          <div className="mb-2 flex items-center gap-2 text-xs text-slate-400">
                            <div className="flex-1 h-1.5 bg-white/10 rounded-full overflow-hidden">
                              <div className="h-full bg-cyan-500 rounded-full transition-all" style={{ width: `${(task.subtasks.filter(s => s.done).length / task.subtasks.length) * 100}%` }} />
                            </div>
                            <span className="font-mono">{task.subtasks.filter(s => s.done).length}/{task.subtasks.length}</span>
                          </div>
                        )}
                        <div className="flex items-center justify-between text-xs text-slate-400">
                          <div className="flex items-center gap-2">
                            {task.priority && <PriorityBadge priority={task.priority} />}
                            <span className="font-mono">{task.assignee || '-'}</span>
                          </div>
                          {taskOverdue && <span className="text-red-400 font-semibold">Atrasada</span>}
                        </div>
                        <div className="mt-2 h-1.5 bg-white/10 rounded-full overflow-hidden">
                          <div
                            className={`h-full rounded-full transition-all ${taskOverdue ? 'bg-red-500' : 'bg-gradient-to-r from-cyan-500 to-blue-500'}`}
                            style={{ width: `${task.progress}%` }}
                          />
                        </div>
                        <div className="mt-1.5 text-xs text-slate-500 font-mono">
                          {new Date(task.start).toLocaleDateString('pt-BR')} - {new Date(task.end).toLocaleDateString('pt-BR')}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // Calendar View Component
    function DashboardView({ project, timeLogs, team }) {
      const tasks = project.tasks || [];
      const total = tasks.length;
      const completed = tasks.filter(t => t.status === 'completed').length;
      const inProgress = tasks.filter(t => t.status === 'in-progress').length;
      const pending = tasks.filter(t => t.status === 'pending').length;
      const overdue = tasks.filter(t => isOverdue(t)).length;
      const avgProgress = total > 0 ? Math.round(tasks.reduce((s, t) => s + (t.progress || 0), 0) / total) : 0;

      const byPriority = { high: 0, medium: 0, low: 0 };
      tasks.forEach(t => { byPriority[t.priority || 'medium']++; });

      const projectLogs = timeLogs.filter(l => l.projectId === project.id);
      const totalHours = projectLogs.reduce((s, l) => s + (l.seconds || 0), 0) / 3600;

      const byAssignee = {};
      tasks.forEach(t => {
        const name = t.assignee || 'Sem respons√°vel';
        if (!byAssignee[name]) byAssignee[name] = { total: 0, completed: 0 };
        byAssignee[name].total++;
        if (t.status === 'completed') byAssignee[name].completed++;
      });

      const StatCard = ({ label, value, sub, color }) => (
        <div className="glass rounded-xl p-4 flex-1 min-w-[140px]">
          <div className={`text-2xl font-bold ${color}`}>{value}</div>
          <div className="text-xs text-slate-400 mt-1">{label}</div>
          {sub && <div className="text-xs text-slate-500 mt-0.5">{sub}</div>}
        </div>
      );

      const Bar = ({ label, value, max, color }) => (
        <div className="flex items-center gap-3 text-sm">
          <span className="w-28 text-slate-400 truncate text-xs">{label}</span>
          <div className="flex-1 h-3 bg-white/10 rounded-full overflow-hidden">
            <div className={`h-full rounded-full ${color}`} style={{ width: `${max > 0 ? (value / max) * 100 : 0}%` }} />
          </div>
          <span className="text-xs font-mono text-slate-300 w-8 text-right">{value}</span>
        </div>
      );

      return (
        <div className="space-y-4 animate-view-transition">
          {/* KPI Cards */}
          <div className="flex flex-wrap gap-3">
            <StatCard label="Total de tarefas" value={total} color="text-white" />
            <StatCard label="Conclu√≠das" value={completed} sub={total > 0 ? `${Math.round(completed/total*100)}%` : ''} color="text-emerald-400" />
            <StatCard label="Em progresso" value={inProgress} color="text-blue-400" />
            <StatCard label="Atrasadas" value={overdue} color={overdue > 0 ? "text-red-400" : "text-slate-500"} />
            <StatCard label="Horas registradas" value={totalHours.toFixed(1)+'h'} color="text-cyan-400" />
            <StatCard label="Progresso m√©dio" value={avgProgress+'%'} color="text-amber-400" />
          </div>

          {/* Status Distribution */}
          <div className="glass rounded-xl p-5">
            <h3 className="text-sm font-semibold text-slate-300 mb-3">Distribui√ß√£o por Status</h3>
            <div className="flex gap-2 h-6 rounded-full overflow-hidden bg-white/5">
              {completed > 0 && <div className="bg-emerald-500 transition-all" style={{ width: `${(completed/total)*100}%` }} title={`Conclu√≠das: ${completed}`} />}
              {inProgress > 0 && <div className="bg-blue-500 transition-all" style={{ width: `${(inProgress/total)*100}%` }} title={`Em progresso: ${inProgress}`} />}
              {pending > 0 && <div className="bg-purple-500 transition-all" style={{ width: `${(pending/total)*100}%` }} title={`Pendentes: ${pending}`} />}
            </div>
            <div className="flex gap-4 mt-2 text-xs text-slate-400">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500" /> Conclu√≠das ({completed})</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500" /> Em progresso ({inProgress})</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500" /> Pendentes ({pending})</span>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* By Priority */}
            <div className="glass rounded-xl p-5">
              <h3 className="text-sm font-semibold text-slate-300 mb-3">Por Prioridade</h3>
              <div className="space-y-2">
                <Bar label="üî¥ Alta" value={byPriority.high} max={total} color="bg-red-500" />
                <Bar label="üü° M√©dia" value={byPriority.medium} max={total} color="bg-amber-500" />
                <Bar label="üü¢ Baixa" value={byPriority.low} max={total} color="bg-emerald-500" />
              </div>
            </div>

            {/* By Assignee */}
            <div className="glass rounded-xl p-5">
              <h3 className="text-sm font-semibold text-slate-300 mb-3">Por Respons√°vel</h3>
              <div className="space-y-2">
                {Object.entries(byAssignee).map(([name, data]) => (
                  <Bar key={name} label={name} value={data.completed} max={data.total} color="bg-cyan-500" />
                ))}
              </div>
              {Object.keys(byAssignee).length === 0 && <p className="text-xs text-slate-500">Nenhuma tarefa atribu√≠da</p>}
            </div>
          </div>
        </div>
      );
    }

    function CalendarView({ project, onEditTask }) {
      const [currentMonth, setCurrentMonth] = useState(() => {
        const now = new Date();
        return { year: now.getFullYear(), month: now.getMonth() };
      });

      const daysInMonth = new Date(currentMonth.year, currentMonth.month + 1, 0).getDate();
      const firstDayOfWeek = new Date(currentMonth.year, currentMonth.month, 1).getDay();
      const monthName = new Date(currentMonth.year, currentMonth.month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

      const prevMonth = () => {
        setCurrentMonth(prev => {
          const m = prev.month - 1;
          return m < 0 ? { year: prev.year - 1, month: 11 } : { year: prev.year, month: m };
        });
      };

      const nextMonth = () => {
        setCurrentMonth(prev => {
          const m = prev.month + 1;
          return m > 11 ? { year: prev.year + 1, month: 0 } : { year: prev.year, month: m };
        });
      };

      const getTasksForDay = (day) => {
        const date = new Date(currentMonth.year, currentMonth.month, day);
        date.setHours(0, 0, 0, 0);
        return project.tasks.filter(task => {
          const start = new Date(task.start); start.setHours(0, 0, 0, 0);
          const end = new Date(task.end); end.setHours(0, 0, 0, 0);
          return date >= start && date <= end;
        });
      };

      const today = new Date();
      const isToday = (day) => today.getFullYear() === currentMonth.year && today.getMonth() === currentMonth.month && today.getDate() === day;

      const getStatusDot = (status) => {
        switch (status) {
          case 'completed': return 'bg-emerald-400';
          case 'in-progress': return 'bg-blue-400';
          case 'pending': return 'bg-purple-400';
          default: return 'bg-slate-400';
        }
      };

      const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
      const cells = [];
      for (let i = 0; i < firstDayOfWeek; i++) cells.push(null);
      for (let d = 1; d <= daysInMonth; d++) cells.push(d);

      if (project.tasks.length === 0) {
        return (
          <div className="glass rounded-2xl p-12 text-center">
            <div className="w-20 h-20 mx-auto mb-4 bg-purple-500/10 rounded-2xl flex items-center justify-center">
              <Calendar className="w-10 h-10 text-purple-400" />
            </div>
            <h3 className="text-xl font-semibold mb-2">Nenhuma tarefa ainda</h3>
            <p className="text-slate-400 text-sm">Use o bot√£o <strong>+ Nova Tarefa</strong> acima para criar tarefas e visualizar o Calend√°rio</p>
          </div>
        );
      }

      return (
        <div className="glass rounded-2xl overflow-hidden">
          <div className="flex items-center justify-between p-4 border-b border-white/10 bg-white/5">
            <button onClick={prevMonth} className="p-2 hover:bg-white/10 rounded-lg transition">
              <ChevronRight className="w-5 h-5 rotate-180" />
            </button>
            <h3 className="text-lg font-bold capitalize">{monthName}</h3>
            <button onClick={nextMonth} className="p-2 hover:bg-white/10 rounded-lg transition">
              <ChevronRight className="w-5 h-5" />
            </button>
          </div>

          <div className="grid grid-cols-7">
            {weekDays.map(d => (
              <div key={d} className="p-2 text-center text-xs font-semibold text-slate-400 border-b border-white/10 bg-white/5">{d}</div>
            ))}
            {cells.map((day, i) => {
              if (!day) return <div key={`empty-${i}`} className="p-2 min-h-[80px] sm:min-h-[100px] border-b border-r border-white/5 bg-white/[0.02]" />;
              const dayTasks = getTasksForDay(day);
              return (
                <div key={day} className={`p-1.5 sm:p-2 min-h-[80px] sm:min-h-[100px] border-b border-r border-white/5 transition hover:bg-white/5 ${isToday(day) ? 'bg-cyan-500/10 border-cyan-500/20' : ''}`}>
                  <div className={`text-xs font-mono mb-1 ${isToday(day) ? 'text-cyan-400 font-bold' : 'text-slate-400'}`}>{day}</div>
                  <div className="space-y-0.5">
                    {dayTasks.slice(0, 3).map(task => (
                      <div
                        key={task.id}
                        onClick={() => onEditTask(task)}
                        className={`text-xs px-1.5 py-0.5 rounded cursor-pointer truncate transition hover:brightness-125 ${isOverdue(task) ? 'bg-red-500/20 text-red-300' : 'bg-white/10 text-slate-300'}`}
                        title={`${task.name} (${task.assignee || 'sem respons√°vel'})`}
                      >
                        <span className={`inline-block w-1.5 h-1.5 rounded-full mr-1 ${getStatusDot(task.status)}`}></span>
                        <span className="hidden sm:inline">{task.name}</span>
                        <span className="sm:hidden">{task.name.substring(0, 8)}</span>
                      </div>
                    ))}
                    {dayTasks.length > 3 && (
                      <div className="text-xs text-slate-500 pl-1">+{dayTasks.length - 3} mais</div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ProjectManager />);
  </script>
</body>
</html>
